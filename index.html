<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DUKKI FoucsFlight</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
/* ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë³€ìˆ˜ ì •ì˜ */
:root {
    --color-primary: #0077ff; 
    --color-accent-red: #dc3545; 
    --color-text-light: #f8f9fa; 
    --color-text-dim: #adb5bd; 
    --color-background-dark: #212529; 
    --color-surface-dark: #343a40; 
    --color-surface-lighter: #495057; 
    --color-surface-translucent: rgba(52, 58, 64, 0.7); 
    --color-border-dark: rgba(255, 255, 255, 0.1); 
    --color-shadow-dark: rgba(0, 0, 0, 0.4); 
}

/* âœˆï¸ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
html, body { height:100%; margin:0; padding:0; }
body { 
    font-family:Arial, sans-serif; 
    background: var(--color-background-dark); 
    color: var(--color-text-light); 
    overflow: hidden; 
}
#map { width:100%; height:100%; position:absolute; top:0; left:0; z-index:0; }

/* ğŸ’ ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ìŠ¤íƒ€ì¼ */
.controls-container, #timerContainer, #bottomNav, .modal-content, .settings-content, #nameModal .modal-content {
    background: var(--color-surface-translucent); 
    -webkit-backdrop-filter: blur(20px); 
    backdrop-filter: blur(20px); 
    border: 1px solid var(--color-border-dark);
    box-shadow: 0 8px 32px 0 var(--color-shadow-dark);
    color: var(--color-text-light);
}

/* ğŸŒŸ ëª¨ë‹¬ ì „ì²´ê°€ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€ */
.modal {
    display: none; 
    position: fixed; top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: rgba(0, 0, 0, 0.6); 
    z-index: 1000; 
    justify-content: center; 
    align-items: flex-start; 
    overflow-y: auto; 
    padding: 20px 0; 
}

/* ğŸŒŸ í‹°ì¼“ ëª¨ë‹¬ ì½˜í…ì¸  í¬ê¸° ì¶•ì†Œ */
.modal-content, .settings-content { 
  background: var(--color-surface-dark); 
  border: 1px solid var(--color-border-dark);
  color: var(--color-text-light); 
  padding: 20px;
  border-radius: 20px;
  width: 90%;
  max-width: 350px; /* â¬…ï¸ í‹°ì¼“íŒ… ì°½ ìµœëŒ€ ë„ˆë¹„ */
  text-align: center;
  margin: auto; 
}

/* ğŸ›‘ ë¹„í–‰ ì‹œì‘/ì™„ë£Œ íŒì—… ìŠ¤íƒ€ì¼ */
.flight-popup {
    display: none; 
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    padding: 15px 25px;
    border-radius: 15px;
    background: var(--color-surface-translucent);
    -webkit-backdrop-filter: blur(20px); 
    backdrop-filter: blur(20px); 
    border: 1px solid var(--color-border-dark);
    box-shadow: 0 8px 32px 0 var(--color-shadow-dark);
    color: var(--color-text-light);
    font-size: 18px;
    font-weight: bold;
    text-align: center;
}

/* ğŸŒŸ ë„ì¥ ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
#stampAnimation {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9998; 
    font-size: 150px; 
    color: var(--color-accent-red);
    text-shadow: 0 0 10px rgba(220, 53, 69, 0.8);
    opacity: 0;
    pointer-events: none;
}

/* ğŸ¯ ë„ì¥ ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ (4ì´ˆ ë™ì•ˆ) */
@keyframes stampEffect {
    0% { transform: translate(-50%, -50%) scale(0.1) rotate(0deg); opacity: 0; }
    5% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); opacity: 1; } 
    10% { transform: translate(-50%, -50%) scale(1) rotate(-5deg); opacity: 1; }
    90% { transform: translate(-50%, -50%) scale(1) rotate(-5deg); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); opacity: 0; } 
}

#stampAnimation.stamp-animate {
    display: block;
    animation: stampEffect 4.0s ease-out forwards;
}

/* ğŸ›©ï¸ ì´ëª¨ì§€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
.emoji-marker-icon {
    font-size: 28px; 
    text-shadow: 0 1px 3px rgba(0,0,0,0.7); 
    background: transparent !important;
    border: none !important;
    display: block !important; 
    justify-content: center;
    align-items: center;
    line-height: 1;
    margin: 0 auto; 
    width: 32px;
    height: 32px;
    z-index: 999; 
    position: absolute !important;
}

/* ğŸŒŸ ê³µí•­ ì •ë³´ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
.airport-marker-icon {
    font-size: 16px;
    font-weight: bold;
    color: var(--color-background-dark);
    background-color: #ffc107; 
    padding: 3px 8px;
    border-radius: 5px;
    border: 1px solid #ff9800;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    white-space: nowrap;
    display: flex;
    align-items: center;
}
.airport-marker-icon span {
    margin-left: 5px;
    color: var(--color-background-dark); 
}
.airport-marker-icon.departure {
    background-color: #ffc107;
    border-color: #ff9800;
}
.airport-marker-icon.arrival {
    background-color: #8aff8a; 
    border-color: #4CAF50;
}

/* --- Controls/Buttons --- */
.controls-container {
  position:absolute; bottom:70px; left:12px; z-index:100;
  padding:10px; border-radius:15px; 
  display:flex; flex-direction:column;
  transition: all 0.3s; 
  min-width: 200px; 
}

/* ğŸŒŸ ì¸ì‚¬ë§ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
#greetingContainer {
    position: absolute;
    bottom: 290px; 
    left: 12px;
    z-index: 100;
    padding: 5px 10px; 
    border-radius: 15px;
    background: transparent; 
    backdrop-filter: none; 
    border: none;
    box-shadow: none; 
    color: var(--color-text-light); 
    font-size: 24px; 
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7); 
    min-width: 200px;
    text-align: left; 
    transition: all 0.3s; 
}

/* input[type="text"] ìŠ¤íƒ€ì¼ */
.controls-container select, 
.controls-container button,
.controls-container input[type="text"],
#nameModal input[type="text"],
#nameModal button { 
  margin:4px 0; font-size:16px; padding:8px 12px; 
  border-radius: 10px; 
  background: var(--color-surface-dark);
  color: var(--color-text-light); 
  border: 1px solid var(--color-border-dark);
  box-sizing: border-box; 
}

.controls-container select,
.controls-container input[type="text"],
#nameModal input[type="text"] {
    width: 100%;
}
.controls-container button,
#nameModal button {
    cursor: pointer;
    width: auto; 
}

.controls-container button:hover,
.controls-container select:hover,
.controls-container input[type="text"]:hover,
#nameModal button:hover,
#nameModal input[type="text"]:hover {
    background: var(--color-surface-lighter);
}
.controls-container select {
    appearance: none; 
    background: var(--color-surface-dark) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="%23adb5bd" d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.094 6.914 4.68 8.328l4.613 4.622z"/></svg>') no-repeat right 10px center;
    background-size: 15px;
}

.controls-container select option {
    background-color: var(--color-surface-dark); 
    color: var(--color-text-light);
}

/* ë„ì°©ì§€ ëª©ë¡ ìŠ¤í¬ë¡¤ */
#arrivalList {
    display: none;
    max-height: 220px; 
    overflow-y: auto;
    padding-right: 5px; 
}

.arrival-item { 
  cursor:pointer; padding:8px 10px; 
  border-radius:10px; 
  margin:4px 0; 
  background: var(--color-surface-dark); 
  color: var(--color-text-light); 
  box-shadow:0 1px 3px var(--color-shadow-dark); 
  transition: all 0.2s;
  /* ë§µì˜ ì œëª©ì²˜ëŸ¼ ë³´ì´ë„ë¡ í°íŠ¸ ì¡°ì • */
  font-weight: bold; 
  font-size: 16px; 
  line-height: 1.4;
}
.arrival-item:hover {
    background: var(--color-surface-lighter);
}
.arrival-item.selected-arrival {
    background: var(--color-surface-dark); 
    color: var(--color-primary); 
    box-shadow: 0 3px 8px rgba(0, 119, 255, 0.5);
    transform: translateY(-1px);
    border: 2px solid var(--color-primary); 
}
.controls-disabled {
    pointer-events: none; 
}

/* 5ì´ˆ ê¾¹ ëˆ„ë¦„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#ticketBtn {
    --progress: 0%; 
    background: var(--color-primary);
    color: white;
    font-weight: bold;
    background-image: linear-gradient(to right, var(--color-accent-red) var(--progress), var(--color-primary) var(--progress));
    background-size: 100% 100%; 
    background-repeat: no-repeat;
    transition: background-image 0.05s linear; 
    border: none;
}
#ticketBtn.disabled-during-flight {
    pointer-events: auto !important; 
}

/* â±ï¸ ì—…ë°ì´íŠ¸ëœ íƒ€ì´ë¨¸ ì»¨í…Œì´ë„ˆ (ì„¸ë¡œ ì¶•ì†Œ ë°˜ì˜) */
#timerContainer {
  position:absolute; top:12px; left:50%; transform:translateX(-50%);
  padding: 8px 20px; /* â¬…ï¸ ì„¸ë¡œ íŒ¨ë”© ì¶•ì†Œ */
  border-radius:15px; 
  z-index:100;
  text-align:center;
  color: var(--color-text-light); 
  /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ íš¨ê³¼ */
  background: var(--color-surface-translucent); 
  -webkit-backdrop-filter: blur(20px); 
  backdrop-filter: blur(20px); 
  border: 1px solid var(--color-border-dark);
  box-shadow: 0 8px 32px 0 var(--color-shadow-dark);
  max-width: 320px; 
  min-width: 150px; 
  width: fit-content; 
}

/* ë¹„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ, ë©”ì¸ ë””ìŠ¤í”Œë ˆì´ ìˆ¨ê¹€ */
#timerMainDisplay.hidden-pre-flight,
#focusStatus.hidden-pre-flight,
#clockContainer.hidden-pre-flight {
    display: none !important;
}

/* ğŸ†• ë¹„í–‰ ì¤‘ì´ ì•„ë‹ ë•Œ, í…ìŠ¤íŠ¸ê°€ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ì˜¤ë„ë¡ ì²˜ë¦¬ */
#timerContainer:not(.is-flight-active) #timerDisplayPreFlight {
    font-size: 18px; 
    font-weight: bold;
    color: var(--color-text-light);
    display: block; 
    margin: 0;
    padding: 0;
}
#timerDisplayPreFlight {
    display: none; 
}

/* âš ï¸ ë¹„í–‰ ì¤‘ì¼ ë•Œë§Œ flex ë ˆì´ì•„ì›ƒ */
#timerMainDisplay {
    display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
    justify-content: space-around;
    padding: 0 10px;
    margin-bottom: 5px; /* â¬…ï¸ ë§ˆì§„ ì¶•ì†Œ */
}
#timerContainer.is-flight-active #timerMainDisplay {
    display: flex;
}

.timer-item {
    text-align: center;
    flex-basis: 50%;
}

.timer-item-label {
    /* ë‚¨ì€ì‹œê°„, ë‚¨ì€ê±°ë¦¬ í…ìŠ¤íŠ¸: íˆ¬ëª…ë„ 70% í°ìƒ‰ */
    color: rgba(248, 249, 250, 0.7); 
    font-size: 13px; /* ì•½ê°„ ì¶•ì†Œ */
    margin-bottom: 2px; /* ì¶•ì†Œ */
    font-weight: bold;
}

.timer-item-value {
    /* ê°’ í…ìŠ¤íŠ¸: ë” í¬ê²Œ, í°ìƒ‰ */
    font-size: 22px; /* ì•½ê°„ ì¶•ì†Œ */
    font-weight: 900; 
    color: var(--color-text-light); 
}

#focusStatus { 
    font-size:15px; /* ì•½ê°„ ì¶•ì†Œ */
    font-weight: bold;
    color: #8aff8a; 
    margin-bottom: 5px; /* ì¶•ì†Œ */
    border-top: 1px solid var(--color-border-dark); 
    padding-top: 5px; /* ì¶•ì†Œ */
} 

/* ğŸ†• í˜„ì¬/í˜„ì§€ ì‹œê°„ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
#clockContainer {
    display: none; /* JSì—ì„œ ë¹„í–‰ ì¤‘ì¼ ë•Œë§Œ flexë¡œ ë³€ê²½ */
    justify-content: space-between;
    gap: 20px;
    border-top: 1px solid var(--color-border-dark); 
    padding-top: 5px; /* â¬…ï¸ íŒ¨ë”© ì¶•ì†Œ */
}
.clock-item {
    font-size: 11px; /* ì¶•ì†Œ */
    line-height: 1.2;
    text-align: left;
    color: var(--color-text-dim);
}
.clock-item strong {
    display: block;
    font-size: 15px; /* ì¶•ì†Œ */
    font-weight: 900;
    color: var(--color-text-light);
    margin-top: 1px; /* ì¶•ì†Œ */
}

/* ğŸ—ºï¸ ì§€ë„ ë”°ë¼ê°€ê¸°/ììœ  ì´ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.follow-toggle-btn {
    position: absolute; 
    top: 12px; 
    right: 12px; 
    z-index: 100;
    width: 45px; 
    height: 45px;
    border-radius: 50%; 
    background: var(--color-surface-translucent);
    -webkit-backdrop-filter: blur(20px); 
    backdrop-filter: blur(20px); 
    border: 1px solid var(--color-border-dark);
    box-shadow: 0 4px 16px 0 var(--color-shadow-dark);
    color: var(--color-text-light);
    font-size: 20px;
    display: none; 
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

/* ğŸ’° ëˆ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ìµœìƒë‹¨ ìš°ì¸¡) */
.money-button {
    position: absolute; 
    top: 12px; 
    right: 12px; 
    z-index: 100;
    width: 60px; 
    height: 45px;
    border-radius: 15px; 
    background: #ffc107; 
    color: #333;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #ff9800;
    box-shadow: 0 4px 16px 0 var(--color-shadow-dark);
    cursor: default;
    transition: all 0.3s ease-in-out; /* ìœ„ì¹˜ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
}

/* ğŸ’° ë¹„í–‰ ì¤‘ ìœ„ì¹˜ ìŠ¤íƒ€ì¼ (follow button ì•„ë˜) */
.money-button.in-flight {
    top: 67px; 
    right: 12px;
    z-index: 100;
}

.follow-toggle-btn:hover {
    background: var(--color-primary);
    color: white;
}

/* ğŸ†• ë¹„í–‰ ì •ë³´ í‘œì‹œ ìŠ¤íƒ€ì¼ */
#selectedFlightInfo {
  padding: 8px 12px;
  border-radius: 10px;
  background: var(--color-surface-dark); 
  border: 2px solid var(--color-primary);
  display: flex; 
  flex-direction: column;
  margin: 4px 0;
  line-height: 1.5; 
}
.flight-subtitle { 
    color: var(--color-primary); 
    font-weight: bold;
    font-size: 14px;
}

/* ğŸ§­ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
#bottomNav { 
    position:fixed; bottom:0; left:0; width:100%; 
    display:flex; justify-content:space-around; 
    padding:8px 0; 
    box-shadow:0 -2px 6px var(--color-shadow-dark); 
    z-index:1000;
}
#bottomNav button {
    background: transparent;
    border: none;
    color: var(--color-text-dim);
    font-size: 14px;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: color 0.2s, background-color 0.2s;
    border-radius: 10px;
}
#bottomNav button.active {
    color: var(--color-primary);
    background: rgba(0, 119, 255, 0.1);
}
#bottomNav button:hover:not(.active) {
    color: var(--color-text-light);
}

/* ğŸ“œ ê¸°ë¡/ì¶”ì„¸ ì»¨í…Œì´ë„ˆ ê³µí†µ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
#recordsContainer, #trendsContainer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--color-background-dark); 
    z-index: 500;
    overflow-y: auto;
    display: none; 
    padding: 20px 0 80px 0; 
}
.close-container-btn {
    position: absolute; top: 20px; right: 20px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px; height: 30px;
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
}

/* ğŸ“ˆ ì¶”ì„¸ ë¶„ì„ ì»¨í…Œì´ë„ˆ ë””ìì¸ (ê¸°ì¡´ ìœ ì§€) */
.trends-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    padding: 0 20px;
}
.trend-item {
    background: var(--color-surface-dark); 
    box-shadow: 0 4px 10px var(--color-shadow-dark); 
    border-radius: 10px;
    padding: 15px;
    text-align: center;
}
.trend-label { color: var(--color-text-dim); font-size: 14px; margin-bottom: 5px; }
.trend-value { color: var(--color-primary); font-size: 28px; font-weight: bold; }
.trend-item:last-child[style*="grid-column"] {
    background: linear-gradient(135deg, var(--color-primary) 10%, var(--color-surface-dark) 80%);
    color: white;
}
.trend-item:last-child[style*="grid-column"] .trend-label,
.trend-item:last-child[style*="grid-column"] .trend-value,
.trend-item:last-child[style*="grid-column"] div {
    color: white !important;
}

/* ğŸ“œ ì—¬í–‰ ê¸°ë¡ ì»¨í…Œì´ë„ˆ ë° í‹°ì¼“ ë””ìì¸ (ê¸°ì¡´ ìœ ì§€) */
#records { padding: 0 10px; }
.ticket-item {
    width: 90%;
    max-width: 400px;
    margin: 20px auto;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 6px 15px var(--color-shadow-dark);
    position: relative;
}
.ticket-main {
    background-color: var(--color-surface-lighter); 
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px dashed #555; 
    color: var(--color-text-light);
    position: relative;
}
.ticket-main::before, .ticket-main::after {
    content: '';
    position: absolute;
    bottom: -10px;
    width: 20px; height: 20px;
    background: var(--color-background-dark); 
    border-radius: 50%;
    z-index: 2;
}
.ticket-main::before { left: -10px; }
.ticket-main::after { right: -10px; }

.ticket-header { color: var(--color-primary); font-size: 20px; font-weight: bold;}
.ticket-time-code { font-size: 14px; color: var(--color-text-dim); margin-top: 5px;}

.ticket-info-panel {
    background-color: var(--color-surface-dark);
    padding: 15px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    font-size: 13px;
    color: var(--color-text-dim);
}
.ticket-info-panel > div {
    width: 50%; 
    box-sizing: border-box;
}
.ticket-info-label { color: var(--color-text-light); font-weight: bold;}
.ticket-info-value { color: var(--color-primary); font-weight: bold;}
#recordsContainer h3 { color: var(--color-primary); }
#clearRecordsBtn { 
    background:var(--color-accent-red); 
    color:white; border:none; 
    padding:8px 15px; border-radius:10px; 
    cursor:pointer;
    margin-bottom: 20px;
}
#recordFilterContainer {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    margin-bottom: 20px;
    padding: 0 20px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}
.record-filter-btn {
    flex: 1;
    padding: 8px 10px;
    border: 2px solid var(--color-surface-lighter);
    background: var(--color-surface-dark);
    color: var(--color-text-dim);
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
.record-filter-btn.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

/* ----------------------------- */
/* ëª¨ë‹¬ ë° ê¸°íƒ€ UI ìŠ¤íƒ€ì¼ */

.modal-content h3, .settings-content h3 { color: var(--color-primary); margin-top: 0;}

/* ëª¨ë‹¬ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
.modal-buttons-container {
    display: flex;
    gap: 10px; 
    margin-top: 20px;
}

/* ëª¨ë‹¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.modal-buttons-container button {
    flex: 1; 
    padding: 10px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

#confirmSelectionBtn {
    background: var(--color-primary);
    color: white;
}

#confirmSelectionBtn:disabled {
    background: var(--color-surface-lighter);
    color: var(--color-text-dim);
    cursor: not-allowed;
    box-shadow: none;
}

#closeModalBtn { 
    background:var(--color-surface-lighter); 
    color:var(--color-text-light); 
}
#saveNameBtn {
    background:var(--color-primary); 
    color:white; 
    flex: 1;
    padding: 10px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
}

/* ğŸŒŸ ì¢Œì„ ì„ íƒ ì»¨í…Œì´ë„ˆ (ì ‘íˆëŠ” ëŒ€ìƒ) */
#seatSelectionContainer {
    max-height: 500px; 
    opacity: 1;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out; 
}
#seatSelectionContainer.collapsed {
    max-height: 0;
    opacity: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin-bottom: 0;
}
/* ì§‘ì¤‘ ëª¨ë“œ ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ í‘œì‹œ */
#focusModeSelector {
    margin-top:15px;
    transition: opacity 0.3s ease-in-out; 
}
/* ğŸŒŸ ì¢Œì„ ë‹¤ì‹œ ì„ íƒ ë²„íŠ¼ ìˆ¨ê¹€/í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
#reselectSeatBtn.hidden {
    display: none !important;
}

/* ì¢Œì„ ë§µ ìŠ¤íƒ€ì¼ */
#seatMap { 
    border:1px solid #495057; 
    padding: 10px;
    border-radius: 10px;
    margin: 15px auto;
    display: flex;
    flex-direction: column;
    align-items: center;
}
#seatMap .row {
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
}
.seat { 
    background:var(--color-surface-lighter); 
    color: var(--color-text-light);
    width: 30px; height: 30px;
    line-height: 30px;
    text-align: center;
    border-radius: 5px;
    margin: 2px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: background 0.1s;
}
.seat.selected { 
    background:var(--color-primary); 
    color:white; 
    box-shadow: 0 0 8px rgba(0, 119, 255, 0.6);
}
.seat:not(.selected):hover:not(.unavailable) {
    background: #5a646c;
}

/* ğŸ†• ì¢Œì„ í´ë˜ìŠ¤ë³„ ìƒ‰ìƒ ì°¨ë³„í™” */
.seat[data-class="F"] { 
    background: #FFD700; /* Gold-like */
    color: #333; 
    font-size: 14px; 
} 
.seat[data-class="B"] { 
    background: #00ADB5; /* Teal-like */
    color: #fff; 
    font-size: 14px; 
} 
.seat[data-class="E"] { 
    background: var(--color-surface-lighter); 
    color: var(--color-text-light);
    font-size: 12px; 
} 
/* ì˜ˆì•½ ë¶ˆê°€ëŠ¥ ì¢Œì„ ìŠ¤íƒ€ì¼ */
.seat.unavailable {
    background: #6c757d !important; /* Dim gray */
    color: #a9a9a9 !important;
    cursor: not-allowed;
    opacity: 0.8;
}

.aisle {
    width: 15px; 
    height: 30px;
    margin: 2px;
}

/* ì§‘ì¤‘ ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#focusModeButtons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px 0;
}
.focus-button { 
    padding: 8px 15px;
    border: none;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s, transform 0.2s, box-shadow 0.2s;
}
.focus-button.selected {
    opacity: 1;
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); 
    border: 2px solid white; 
}

/* âš™ï¸ ì„¤ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
.settings-content button {
    background: var(--color-surface-lighter);
    color: var(--color-text-light);
    border: 2px solid #495057; 
    margin: 5px;
    padding: 10px 15px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
    width: 100%; /* ë„ˆë¹„ 100%ë¡œ ì„¤ì • */
    box-sizing: border-box; /* íŒ¨ë”©, ë³´ë”ê°€ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ ì„¤ì • */
}
.map-style-button.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
    font-weight: bold;
}
.close-container-btn {
    background: var(--color-primary);
    color: white;
}
.settings-content div {
    color: var(--color-text-dim) !important; 
    margin-bottom: 15px;
}
#mapStyleButtons {
    display: flex;
    justify-content: space-around;
    gap: 10px;
    margin-bottom: 15px;
}
#mapStyleButtons .map-style-button {
    flex: 1;
    margin: 0;
}


/* ğŸ« í‹°ì¼“/ë°”ì½”ë“œ ìŠ¤íƒ€ì¼ (í”„ë¦°íŠ¸ ëª¨ì…˜ ìœ ì§€) */
#boardingPassContainer {
    margin-top: 20px;
    background: var(--color-surface-lighter);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 4px 15px var(--color-shadow-dark);
    
    max-height: 0;
    opacity: 0;
    /* ğŸ¯ ë°œê¶Œ ì• ë‹ˆë©”ì´ì…˜ ì†ë„ 3.0ì´ˆ ìœ ì§€ */
    transition: max-height 3.0s ease-out, opacity 1.0s ease-out; 
}
#boardingPassContainer.show {
    max-height: 500px; 
    opacity: 1;
}

.boarding-pass {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--color-surface-lighter);
    border-bottom: 2px dashed var(--color-border-dark); 
    position: relative;
}

.boarding-pass::before,
.boarding-pass::after {
    content: '';
    position: absolute;
    bottom: -10px;
    width: 20px; height: 20px;
    background: var(--color-surface-dark); 
    border-radius: 50%;
    z-index: 2;
}
.boarding-pass::before { left: -10px; }
.boarding-pass::after { right: -10px; }

.bp-info {
    text-align: left;
}
.bp-route {
    font-size: 20px;
    font-weight: bold;
    color: var(--color-primary);
}
.bp-details {
    font-size: 12px;
    color: var(--color-text-dim);
    margin-top: 5px;
}
.bp-seat-mode {
    text-align: right;
}
.bp-seat {
    font-size: 24px;
    font-weight: 900;
    color: #ff8888;
}
.bp-mode {
    font-size: 14px;
    color: var(--color-text-light);
}

.barcode-panel {
    padding: 10px 15px;
    background: var(--color-surface-dark);
    text-align: center;
}
.barcode {
    display: block;
    width: 80%;
    height: 60px;
    margin: 5px auto;
    background: repeating-linear-gradient(
        90deg, 
        #000, #000 2px, 
        transparent 2px, transparent 4px
    );
    background-size: 10px 100%;
    border: 1px solid #000;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
}
.barcode-text {
    font-family: monospace;
    font-size: 10px;
    color: var(--color-text-dim);
}

/* ğŸš€ ìŠ¬ë¼ì´ë“œí•˜ì—¬ ë¹„í–‰ ì‹œì‘ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
#slideTrack {
    position: relative;
    width: 90%;
    height: 35px;
    margin: 15px auto 10px auto;
    background: var(--color-surface-lighter); 
    border-radius: 20px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
    cursor: grab; 
    user-select: none;
    overflow: hidden;
}

#slideTrack.sliding {
    cursor: grabbing;
}

#slideBackground {
    position: absolute;
    top: 0; left: 0;
    width: 0; 
    height: 100%;
    background: var(--color-primary);
    border-radius: 20px;
    transition: background-color 0.2s;
    z-index: 1;
}

#slideText {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    line-height: 35px;
    color: var(--color-text-dim);
    font-weight: bold;
    font-size: 15px;
    z-index: 2;
    pointer-events: none; 
}

#slideHandle {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 40px;
    height: 31px;
    background: var(--color-primary);
    border-radius: 17px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
    z-index: 3;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    cursor: grab; 
}

#slideHandle:hover {
    background: #0099ff;
}
/* ------------------------------------------------ */
</style>
</head>
<body class="map-style-satellite"> 

<div id="map"></div>

<div id="flightPopup" class="flight-popup" style="display:none;"></div>

<div id="stampAnimation">
    <div style="
        font-size: 0.8em; 
        font-weight: 900; 
        line-height: 1;
        transform: rotate(10deg);
        border: 10px solid var(--color-accent-red); 
        border-radius: 50%; 
        padding: 40px; 
        display: inline-block;
        background: rgba(0,0,0,0.2);
    ">
        <span style="display: block; transform: rotate(-10deg);">
            <span style="font-size: 0.3em; display: block;">FLIGHT</span>
            <span style="font-size: 1em; display: block;">COMPLETED</span>
            <span style="font-size: 0.3em; display: block;">âœˆï¸</span>
        </span>
    </div>
</div>

<div id="greetingContainer" style="display: none;">
</div>

<div class="controls-container">
  <input type="text" id="departureSearch" placeholder="ì¶œë°œì§€ ê²€ìƒ‰ (ë„ì‹œ, ì½”ë“œ)">
  <select id="departureSelect">
    <option value="" disabled selected>ì¶œë°œ ë„ì‹œ ì„ íƒ</option>
  </select>
  <div id="selectedFlightInfo" style="display:none;"></div> 
  <input type="text" id="arrivalSearch" placeholder="ë„ì°©ì§€ ê²€ìƒ‰ (ë„ì‹œ, ì½”ë“œ)" style="display:none;">
  <div id="arrivalList"></div>
  <button id="ticketBtn" style="display:none;">ì¢Œì„ ì„ íƒ</button>
</div>

<div id="timerContainer">
    <div id="timerMainDisplay">
        <div id="timeItem" class="timer-item">
            <div class="timer-item-label">ë‚¨ì€ ì‹œê°„</div>
            <div id="timerDisplay" class="timer-item-value"></div>
        </div>
        <div id="distanceItem" class="timer-item">
            <div class="timer-item-label">ë‚¨ì€ ê±°ë¦¬</div>
            <div id="distanceDisplay" class="timer-item-value"></div>
        </div>
    </div>
    
    <div id="focusStatus"></div>
    
    <div id="clockContainer">
        <div id="currentTimeDisplay" class="clock-item"></div>
        <div id="localTimeDisplay" class="clock-item"></div>
    </div>
    
    <div id="timerDisplayPreFlight">DUKKI Foucs</div>
</div>

<button id="moneyButton" class="money-button">
    ğŸ’° <span id="moneyDisplay">1</span>
</button>

<button id="toggleFollowBtn" class="follow-toggle-btn">
    <span id="followIcon">ğŸ“</span>
</button>

<audio id="backgroundMusic" autoplay loop>
  <source src="https://docs.google.com/uc?export=open&id=1EV3gufDmn-jWjh_DrPgRRxA_tYksHqfh" type="audio/mp3" />
  Your browser does not support the audio element.
</audio>

<div id="recordsContainer">
  <button class="close-container-btn">Ã—</button> 
  <h3 style="text-align:center; margin-top:50px;">âœˆï¸ ì—¬í–‰ ê¸°ë¡</h3>
  
  <div id="recordFilterContainer">
      <button class="record-filter-btn active" data-filter="all">ì „ì²´</button>
      <button class="record-filter-btn" data-filter="completed">ì™„ë£Œí•¨</button>
      <button class="record-filter-btn" data-filter="incomplete">ë¯¸ì™„ë£Œ</button>
  </div>
  
  <div style="text-align: center; padding: 0 20px;">
    <button id="clearRecordsBtn">ê¸°ë¡ ì´ˆê¸°í™”</button>
  </div>
  <div id="records"></div>
</div>

<div id="trendsContainer">
  <button class="close-container-btn">Ã—</button> 
  <h3 style="text-align:center; margin-top:50px;">ğŸ“Š ë¹„í–‰ ì¶”ì„¸ ë¶„ì„</h3>
  <div class="trends-grid" id="trendsData">
    </div>
</div>

<div class="modal" id="ticketModal">
  <div class="modal-content">
    <h3>í‹°ì¼“íŒ…</h3>
    
    <div style="text-align:center; font-weight:bold; margin-bottom:10px;">
      ì„ íƒ: <span id="selectedSeatDisplay" style="color:var(--color-primary);">ì¢Œì„ ì—†ìŒ</span> / 
      <span id="selectedFocusModeDisplay" style="color:var(--color-primary);">ëª¨ë“œ ì—†ìŒ</span>
    </div>

    <div id="seatSelectionContainer">
        <div id="seatMap"></div>
    </div>
    
    <div id="focusModeSelector"> 
        ì§‘ì¤‘ ëª¨ë“œ ì„ íƒ:
        <div id="focusModeButtons"></div> 
    </div>

    <button id="reselectSeatBtn" class="hidden" style="width:100%; background: var(--color-surface-lighter); color: var(--color-text-light); border: 1px solid var(--color-border-dark); margin-top: 5px;">
        ì¢Œì„ ë‹¤ì‹œ ì„ íƒ ğŸ”„
    </button>
    
    <div class="modal-buttons-container" id="selectionButtons">
        <button id="confirmSelectionBtn" disabled>ì„ íƒ ì™„ë£Œ (í‹°ì¼“ ë°œê¶Œ)</button>
        <button id="closeModalBtn">ì·¨ì†Œ</button>
    </div>

    <div id="boardingPassContainer" style="display:none;">
        <div class="boarding-pass">
            <div class="bp-info">
                <div class="bp-route" id="bpRoute">ICN â†’ JFK</div>
                <div class="bp-details">
                    <span id="bpFlightNo">FLT: AA000</span> | 
                    <span id="bpGate">GATE: A9</span> |
                    <span id="bpClass">CLASS: F</span>
                </div>
            </div>
            <div class="bp-seat-mode">
                <div class="bp-seat" id="bpSeat">A-Z</div>
                <div class="bp-mode" id="bpFocusMode"></div> 
            </div>
        </div>
        <div class="barcode-panel">
            <div class="barcode"></div>
            <div class="barcode-text" id="bpBarcodeText">FOCUSFLIGHT-A9-A-Z-STUDY-DUKKI</div>
            
            <div id="slideTrack">
                <div id="slideBackground"></div>
                <div id="slideHandle">âœˆï¸</div>
                <div id="slideText">ë°€ì–´ì„œ í‹°ì¼“ ìŠ¤ìº” ğŸ«</div> 
            </div>
            <div style="font-size:12px; color:#fff; font-weight:bold; margin-top: 5px; display:none;">
                ê²Œì´íŠ¸ì— í‹°ì¼“ì„ ìŠ¤ìº”í•˜ì„¸ìš”
            </div>
        </div>
    </div>
    
  </div>
</div>

<div class="modal" id="nameModal">
    <div class="modal-content">
        <h3>í™˜ì˜í•©ë‹ˆë‹¤! ğŸš€</h3>
        <p>ì§‘ì¤‘ ë¹„í–‰ ì‹œë®¬ë ˆì´í„°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
        <input type="text" id="userNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button id="saveNameBtn" style="margin-top: 20px;">ì´ë¦„ ì„¤ì • ì™„ë£Œ</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="settings-content">
        <h3>ì„¤ì • âš™ï¸</h3>
        <button id="editNameBtn">ì´ë¦„ ìˆ˜ì •í•˜ê¸°</button>
        
        <h4 style="color:var(--color-primary); margin-top: 20px; margin-bottom: 5px;">ì§€ë„ ìŠ¤íƒ€ì¼ ì„¤ì • ğŸ—ºï¸</h4>
        <div id="mapStyleButtons">
            <button class="map-style-button" data-style="2d">2D ì¼ë°˜ ì§€ë„</button>
            <button class="map-style-button active" data-style="satellite">ìœ„ì„± ì§€ë„</button> 
        </div>
        
        <h4 style="color:var(--color-primary); margin-top: 20px; margin-bottom: 5px;">ë°ì´í„° ê´€ë¦¬ ğŸ’¾</h4>
        <button onclick="exportData()">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="importData()">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        
        <div style="font-size: 12px; color: #888; text-align: center; margin-top: 10px;">By TEAMBUCK</div> 
        <button id="closeSettingsModalBtn">ë‹«ê¸°</button>
    </div>
</div>

<div id="bottomNav">
  <button id="homeBtn" class="active">í™ˆ</button>
  <button id="recordBtn">ì—¬í–‰ ê¸°ë¡</button>
  <button id="trendsBtn">ì¶”ì„¸</button>
  <button id="settingsBtn">âš™ï¸ ì„¤ì •</button> 
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// â­ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
document.addEventListener('DOMContentLoaded', function() {

    // ğŸ—ºï¸ ê³µí•­ ë°ì´í„° (34ê°œ)
    const airportData={
      'Seoul':{code:'ICN',name:'Incheon International Airport',lat:37.4602,lon:126.4407, tzOffset: 9},
      'Gimpo':{code:'GMP',name:'Gimpo International Airport',lat:37.5583,lon:126.7905, tzOffset: 9}, 
      'Jeju':{code:'CJU',name:'Jeju International Airport',lat:33.5115,lon:126.4928, tzOffset: 9},
      'Busan':{code:'PUS',name:'Gimhae International Airport',lat:35.1764,lon:128.9377, tzOffset: 9},
      'New York':{code:'JFK',name:'John F. Kennedy International Airport',lat:40.6413,lon:-73.7781, tzOffset: -5},
      'London':{code:'LHR',name:'London Heathrow Airport',lat:51.4700,lon:-0.4543, tzOffset: 0},
      'Tokyo':{code:'NRT',name:'Narita International Airport',lat:35.773,lon:140.3929, tzOffset: 9},
      'Sydney':{code:'SYD',name:'Sydney Kingsford Smith Airport',lat:-33.9399,lon:151.1753, tzOffset: 11},
      'Paris':{code:'CDG',name:'Charles de Gaulle Airport',lat:49.0097,lon:2.5479, tzOffset: 1},
      'Los Angeles':{code:'LAX',name:'Los Angeles International Airport',lat:33.9416,lon:-118.4085, tzOffset: -8},
      'Dubai':{code:'DXB',name:'Dubai International Airport',lat:25.2532,lon:55.3653, tzOffset: 4},
      'Beijing':{code:'PEK',name:'Beijing Capital International Airport',lat:40.0801,lon:116.6031, tzOffset: 8},
      'Singapore':{code:'SIN',name:'Singapore Changi Airport',lat:1.3592,lon:103.9893, tzOffset: 8},
      'Frankfurt':{code:'FRA',name:'Frankfurt Airport',lat:50.0379,lon:8.5622, tzOffset: 1},
      'Amsterdam':{code:'AMS',name:'Amsterdam Airport Schhol',lat:52.3105,lon:4.7683, tzOffset: 1},
      'Hong Kong':{code:'HKG',name:'Hong Kong International Airport',lat:22.3080,lon:113.9184, tzOffset: 8},
      'Chicago':{code:'ORD',name:'O\'Hare International Airport',lat:41.9742,lon:-87.9073, tzOffset: -6},
      'Toronto':{code:'YYZ',name:'Toronto Pearson International Airport',lat:43.6777,lon:-79.6248, tzOffset: -5},
      'Istanbul':{code:'IST',name:'Istanbul Airport',lat:41.2036,lon:28.9855, tzOffset: 3},
      'Bangkok':{code:'BKK',name:'Suvarnabhumi Airport',lat:13.6811,lon:100.7473, tzOffset: 7},
      'Mumbai':{code:'BOM',name:'Chhatrapati Shivaji Maharaj Intl Airport',lat:19.0886,lon:72.8679, tzOffset: 5.5},
      'Madrid':{code:'MAD',name:'Adolfo SuÃ¡rez Madridâ€“Barajas Airport',lat:40.4839,lon:-3.5679, tzOffset: 1},
      'Moscow':{code:'SVO',name:'Sheremetyevo International Airport',lat:55.9726,lon:37.4146, tzOffset: 3},
      'Dallas':{code:'DFW',name:'Dallas/Fort Worth International Airport',lat:32.8998,lon:-97.0403, tzOffset: -6},
      'Rome':{code:'FCO',name:'Leonardo da Vinciâ€“Fiumicino Airport',lat:41.8003,lon:12.2464, tzOffset: 1},
      'Mexico City':{code:'MEX',name:'Mexico City International Airport',lat:19.4363,lon:-99.0720, tzOffset: -6},
      'Cairo':{code:'CAI',name:'Cairo International Airport',lat:30.1219,lon:31.3920, tzOffset: 2},
      'Rio de Janeiro':{code:'GIG',name:'Rio de Janeiro Intl Airport',lat:-22.8122,lon:-43.2492, tzOffset: -3},
      'Cape Town':{code:'CPT',name:'Cape Town International Airport',lat:-33.9685,lon:18.5975, tzOffset: 2},
      'Vancouver':{code:'YVR',name:'Vancouver International Airport',lat:49.1939,lon:-123.1842, tzOffset: -8},
      'Taipei':{code:'TPE',name:'Taiwan Taoyuan International Airport',lat:25.0777,lon:121.2325, tzOffset: 8},
      'Auckland':{code:'AKL',name:'Auckland Airport',lat:-37.0082,lon:174.7917, tzOffset: 13},
      'Doha':{code:'DOH',name:'Hamad International Airport',lat:25.2731,lon:51.6053, tzOffset: 3},
      'Boston':{code:'BOS',name:'Logan International Airport',lat:42.3656,lon:-71.0096, tzOffset: -5}
    };

    // âœˆï¸ ë¹„í–‰ ì‹œê°„ (ê¸°ì¡´ ìœ ì§€)
    const flightTimes = {};
    const cities = Object.keys(airportData);
    
    // í—¬í¼ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
    const R = 6371; 
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; 
    }
    
    cities.forEach((city1) => {
        const dep = airportData[city1];
        cities.forEach((city2) => {
            if (city1 === city2) return; 

            const arr = airportData[city2];
            const key = `${city1}-${city2}`;

            const distance = calculateDistance(dep.lat, dep.lon, arr.lat, arr.lon);
            let durationHours = distance / 800; 
            durationHours = Math.max(0.5, durationHours); 
            durationHours = Math.min(24, durationHours); 
            durationHours += (Math.random() - 0.5) * 1; 
            const durationSec = Math.round(durationHours * 3600);
            flightTimes[key] = durationSec;
        });
    });
    
    // (ìˆ˜ë™ ì‹œê°„ ì¡°ì •)
    flightTimes['Gimpo-Seoul'] = 0.5*3600;
    flightTimes['Seoul-Gimpo'] = 0.5*3600;
    flightTimes['Gimpo-Jeju'] = 1*3600 + 10*60;
    flightTimes['Seoul-Jeju'] = 1*3600 + 10*60;
    flightTimes['Seoul-Busan'] = 1*3600;
    flightTimes['Seoul-Tokyo'] = 2.5*3600;
    flightTimes['Seoul-New York'] = 15*3600+40*60;
    flightTimes['Seoul-London'] = 11*3600+30*60;
    flightTimes['Seoul-Sydney'] = 10*3600;
    flightTimes['New York-London'] = 7*3600+30*60;

    // ----------------------------------------------------
    // âš™ï¸ ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
    // ----------------------------------------------------
    let currentDeparture=null;
    let selectedArrival=null;
    let selectedSeat=null; 
    let selectedFocusMode=null; 
    let pendingFlight=null;
    let timerInterval=null;
    let timerSeconds=0;
    let flightMarker=null, flightLine=null;
    let autoFollow=true; 
    let initialFlightDistance = 0; 
    
    let userName = null; 
    let currentRecordFilter = 'all'; 

    let pressTimer = null;
    const PRESS_DURATION = 5000; 
    
    let departureAirportMarker = null; 
    let arrivalAirportMarker = null; 

    // ğŸ†• ì¢Œì„ ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ ìƒíƒœë¥¼ ì €ì¥í•  ë§µ
    let seatAvailabilityMap = {};
    
    // ğŸ†• ëˆ ê´€ë ¨ ë³€ìˆ˜ ë° ìƒìˆ˜
    let currentMoney = parseInt(localStorage.getItem('focusFlightMoney')) || 1;
    const MONEY_GAIN_PER_KM = 5 / 20; 
    let lastMoneyGainDistance = 0; 

    // ----------------------------------------------------
    // ğŸ“Œ DOM ìš”ì†Œ ì°¸ì¡°
    // ----------------------------------------------------
    const timerContainer = document.getElementById('timerContainer');
    const timerDisplay = document.getElementById('timerDisplay');
    const timerDisplayPreFlight = document.getElementById('timerDisplayPreFlight');
    const timerMainDisplay = document.getElementById('timerMainDisplay'); 
    const focusStatus = document.getElementById('focusStatus');
    const distanceDisplay = document.getElementById('distanceDisplay'); 
    const departureSearch = document.getElementById('departureSearch');
    const arrivalSearch = document.getElementById('arrivalSearch');
    const departureSelect = document.getElementById('departureSelect');
    const controlsContainer = document.querySelector('.controls-container');
    const selectedFlightInfo = document.getElementById('selectedFlightInfo'); 
    const arrivalList = document.getElementById('arrivalList');
    const ticketBtn = document.getElementById('ticketBtn');
    const modal = document.getElementById('ticketModal');
    const selectedSeatDisplay = document.getElementById('selectedSeatDisplay');
    const selectedFocusModeDisplay = document.getElementById('selectedFocusModeDisplay'); 
    const focusModeButtonsContainer = document.getElementById('focusModeButtons');
    const recordsContainer = document.getElementById('recordsContainer');
    const trendsContainer = document.getElementById('trendsContainer'); 
    const clearRecordsBtn = document.getElementById('clearRecordsBtn'); 
    const bottomNavButtons = document.querySelectorAll('#bottomNav button');
    const flightPopup = document.getElementById('flightPopup');
    const recordFilterButtons = document.querySelectorAll('.record-filter-btn');
    const settingsBtn = document.getElementById('settingsBtn'); 
    const settingsModal = document.getElementById('settingsModal'); 
    const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn'); 
    const editNameBtn = document.getElementById('editNameBtn'); 
    const boardingPassContainer = document.getElementById('boardingPassContainer');
    const confirmSelectionBtn = document.getElementById('confirmSelectionBtn');
    const seatMap = document.getElementById('seatMap');
    const bpRoute = document.getElementById('bpRoute');
    const bpFlightNo = document.getElementById('bpFlightNo');
    const bpSeat = document.getElementById('bpSeat');
    const bpFocusMode = document.getElementById('bpFocusMode');
    const bpBarcodeText = document.getElementById('bpBarcodeText');
    const bpGate = document.getElementById('bpGate');
    const bpClass = document.getElementById('bpClass');
    const slideTrack = document.getElementById('slideTrack');
    const slideHandle = document.getElementById('slideHandle');
    const slideBackground = document.getElementById('slideBackground');
    const slideText = document.getElementById('slideText');
    const nameModal = document.getElementById('nameModal');
    const userNameInput = document.getElementById('userNameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const greetingContainer = document.getElementById('greetingContainer');
    const seatSelectionContainer = document.getElementById('seatSelectionContainer'); 
    const reselectSeatBtn = document.getElementById('reselectSeatBtn'); 
    const selectionButtons = document.getElementById('selectionButtons'); 
    
    const stampAnimation = document.getElementById('stampAnimation');
    
    const toggleFollowBtn = document.getElementById('toggleFollowBtn');
    const followIcon = document.getElementById('followIcon');
    
    const backgroundMusic = document.getElementById('backgroundMusic'); 
    
    // ğŸ†• í´ë½ ê´€ë ¨ DOM ìš”ì†Œ
    const clockContainer = document.getElementById('clockContainer');
    const currentTimeDisplay = document.getElementById('currentTimeDisplay');
    const localTimeDisplay = document.getElementById('localTimeDisplay');
    
    // ğŸ†• ëˆ ê´€ë ¨ DOM ìš”ì†Œ
    const moneyButton = document.getElementById('moneyButton');
    const moneyDisplay = document.getElementById('moneyDisplay');
    
    let currentBaseLayer = null;
    
    const airplaneIcon = L.divIcon({
        html: 'âœˆï¸',
        className: 'emoji-marker-icon', 
        iconSize: [32, 32], 
        iconAnchor: [16, 16], 
        popupAnchor: [0, -16]
    });
    
    /**
     * ğŸŒŸ ê³µí•­ ë§ˆì»¤ ì•„ì´ì½˜ ì •ì˜ í—¬í¼ (ê¸°ì¡´ ìœ ì§€)
     */
    function createAirportIcon(code, isDeparture = true) {
        return L.divIcon({
            html: `${isDeparture ? 'ğŸ›«' : 'ğŸ›¬'} <span>${code}</span>`,
            className: `airport-marker-icon ${isDeparture ? 'departure' : 'arrival'}`,
            iconSize: [50, 20], 
            iconAnchor: [0, 10] 
        });
    }

    // â­ Leaflet ì§€ë„ ê°ì²´ ì´ˆê¸°í™” (ê¸°ì¡´ ìœ ì§€)
    const map=L.map('map',{zoomControl:true}).setView([20,0],2);
    
    // ----------------------------------------------------
    // ğŸ”„ UI ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ (íƒ€ì´ë¨¸)
    // ----------------------------------------------------
    function initializeTimerUI() {
        timerContainer.classList.remove('is-flight-active');
        timerMainDisplay.style.display = 'none';
        focusStatus.style.display = 'none';
        clockContainer.style.display = 'none';
        
        timerDisplayPreFlight.style.display = 'block'; 
        timerDisplayPreFlight.textContent = 'DUKKI Foucs';
        
        distanceDisplay.textContent = '0 km'; 
        timerDisplay.textContent = 'DUKKI Foucs';
        focusStatus.textContent = ''; 
    }
    
    // ğŸ’µ ëˆ UI ì´ˆê¸°í™”
    function initializeMoneyUI() {
        currentMoney = parseInt(localStorage.getItem('focusFlightMoney')) || 1; // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë‹¤ì‹œ ë¡œë“œ
        moneyDisplay.textContent = currentMoney;
        moneyButton.classList.remove('in-flight'); // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
    }

    initializeTimerUI(); 
    initializeMoneyUI(); 

    // ----------------------------------------------------
    // ğŸ›°ï¸ ì§€ë„ ë ˆì´ì–´ ì •ì˜ ë° ì´ˆê¸°í™” í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------

    const baseLayers = {
        "2D ì¼ë°˜ ì§€ë„": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            attribution:'Â© OpenStreetMap'
        }),
        "ìœ„ì„± ì§€ë„": L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3'],
            attribution:'&copy; Google Satellite'
        })
    };

    function initializeMapLayers() {
        const savedStyle = localStorage.getItem('focusFlightMapStyle') || 'satellite';
        currentBaseLayer = baseLayers[savedStyle === '2d' ? "2D ì¼ë°˜ ì§€ë„" : "ìœ„ì„± ì§€ë„"];
        currentBaseLayer.addTo(map);
        document.body.classList.remove('map-style-satellite', 'map-style-2d'); 
        document.body.classList.add(`map-style-${savedStyle}`); 
        map.setZoom(2); 

        // ë²„íŠ¼ ì´ˆê¸° í™œì„±í™” ìƒíƒœ ì„¤ì •
        document.querySelectorAll('.map-style-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.style === savedStyle) {
                btn.classList.add('active');
            }
        });
    }
    
    function switchMapStyle(style) {
        if (currentBaseLayer && map.hasLayer(currentBaseLayer)) {
            map.removeLayer(currentBaseLayer);
        }
        
        if (style === '2d') {
            currentBaseLayer = baseLayers["2D ì¼ë°˜ ì§€ë„"];
            currentBaseLayer.addTo(map);
            document.body.classList.remove('map-style-satellite'); 
            document.body.classList.add('map-style-2d'); 
            map.setView([20, 0], 2); 
        } else if (style === 'satellite') {
            currentBaseLayer = baseLayers["ìœ„ì„± ì§€ë„"];
            currentBaseLayer.addTo(map);
            document.body.classList.remove('map-style-2d'); 
            document.body.classList.add('map-style-satellite'); 
            map.setView([20, 0], 2); 
        }
        
        localStorage.setItem('focusFlightMapStyle', style); // ì„¤ì • ì €ì¥

        document.querySelectorAll('.map-style-button').forEach(btn => {
            if (btn.dataset.style === style) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        if (flightLine) { flightLine.addTo(map); }
        if (flightMarker) { flightMarker.addTo(map); }
        if (departureAirportMarker) { departureAirportMarker.addTo(map); }
        if (arrivalAirportMarker) { arrivalAirportMarker.addTo(map); }
    }

    // ì´ˆê¸°í™” í˜¸ì¶œ
    initializeMapLayers();
    // ----------------------------------------------------
    
    // ğŸ—ºï¸ ì§€ë„ ë”°ë¼ê°€ê¸°/ììœ  ì´ë™ í† ê¸€ ê¸°ëŠ¥
    function toggleFollow() {
        autoFollow = !autoFollow;
        if (autoFollow) {
            followIcon.textContent = 'ğŸ“'; 
            map.setView(flightMarker ? flightMarker.getLatLng() : map.getCenter(), 13, { animate: true, duration: 0.5 });
            map.dragging.enable();
            map.touchZoom.enable();
            map.doubleClickZoom.enable();
            map.scrollWheelZoom.enable();
            map.boxZoom.enable();
            map.keyboard.enable();
        } else {
            followIcon.textContent = 'â˜ï¸'; 
            map.setView(map.getCenter(), 8, { animate: true, duration: 0.5 });
        }
    }
    
    // ì´ˆê¸° ì•„ì´ì½˜ ì„¤ì • (ê¸°ë³¸ê°’: ğŸ“)
    followIcon.textContent = 'ğŸ“';
    toggleFollowBtn.onclick = toggleFollow;
    
    // ----------------------------------------------------
    // ğŸŒŸ ì´ë¦„ ê´€ë ¨ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
    
    function loadUserName() {
        userName = localStorage.getItem('focusFlightUserName');
        if (!userName) {
            nameModal.querySelector('h3').textContent = 'í™˜ì˜í•©ë‹ˆë‹¤! ğŸš€';
            nameModal.querySelector('p').innerHTML = 'ì§‘ì¤‘ ë¹„í–‰ ì‹œë®¬ë ˆì´í„°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.';
            showNameModal();
        } else {
            updateGreeting(userName);
        }
    }

    function showNameModal() {
        nameModal.style.display = 'flex';
        userNameInput.value = userName || ''; 
        userNameInput.focus();
    }
    
    function updateGreeting(name) {
        const greeting = getGreeting();
        greetingContainer.textContent = `${greeting}, ${name} âœˆï¸`;
        greetingContainer.style.display = 'block';
    }

    function getGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) {
            return 'êµ¿ëª¨ë‹';
        } else if (hour >= 12 && hour < 17) {
            return 'êµ¿ì• í”„í„°ëˆˆ';
        } else if (hour >= 17 && hour < 22) {
            return 'êµ¿ì´ë¸Œë‹';
        } else {
            return 'êµ¿ë‚˜ì‡';
        }
    }

    saveNameBtn.onclick = () => {
        const inputName = userNameInput.value.trim();
        if (inputName) {
            localStorage.setItem('focusFlightUserName', inputName);
            userName = inputName;
            updateGreeting(userName);
            nameModal.style.display = 'none';
        } else {
            alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
    };
    
    editNameBtn.onclick = () => {
        settingsModal.style.display = 'none'; 
        nameModal.querySelector('h3').textContent = 'ì´ë¦„ ìˆ˜ì • âœï¸';
        nameModal.querySelector('p').innerHTML = 'ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        showNameModal();
    };

    // ----------------------------------------------------
    // ğŸŒ ì‹œê°„ ë° ìœ„ì¹˜ ê´€ë ¨ í—¬í¼ í•¨ìˆ˜ ì¶”ê°€ (ì—…ë°ì´íŠ¸)
    // ----------------------------------------------------

    let clockInterval = null;
    
    /**
     * â° í˜„ì¬ ì‹œê°„ ë° í˜„ì§€ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
     */
    function updateClocks() {
        const now = new Date();
        const currentHours = now.getHours();
        const currentMinutes = String(now.getMinutes()).padStart(2, '0');
        
        let depTimezone = 'KST';
        let arrTimezone = 'UTC';

        // 1. í˜„ì¬ ì‹œê°„ (ì‹œìŠ¤í…œ ì‹œê°„)
        currentTimeDisplay.innerHTML = `í˜„ì¬ ì‹œê°„<br><strong>${String(currentHours).padStart(2, '0')}:${currentMinutes}</strong>`;

        // 2. í˜„ì§€ ì‹œê°„ (ë„ì°©ì§€ ì‹œì°¨ ì ìš©)
        if (selectedArrival && airportData[selectedArrival]) {
            const arrOffset = airportData[selectedArrival].tzOffset; // ë„ì°©ì§€ ì‹œì°¨ (KST: 9 ê¸°ì¤€)
            const kstOffset = 9; // KST ê¸°ì¤€ ì‹œì°¨
            
            const diff = arrOffset - kstOffset;
            
            let localOffsetHours = currentHours + diff; 
            
            // ì‹œì°¨ ê³„ì‚° (24ì‹œê°„ ì£¼ê¸° ì¡°ì •)
            if (localOffsetHours >= 24) localOffsetHours -= 24;
            else if (localOffsetHours < 0) localOffsetHours += 24;
            
            const localHours = String(localOffsetHours).padStart(2, '0');
            arrTimezone = `(UTC${arrOffset > 0 ? '+' : ''}${arrOffset})`; 

            localTimeDisplay.innerHTML = `í˜„ì§€ ì‹œê°„ ${arrTimezone}<br><strong>${localHours}:${currentMinutes}</strong>`;
        } else {
             localTimeDisplay.innerHTML = `í˜„ì§€ ì‹œê°„<br><strong>--:--</strong>`;
        }
        
    }
    
    // 1ë¶„ë§ˆë‹¤ ì‹œê³„ ì—…ë°ì´íŠ¸
    clockInterval = setInterval(updateClocks, 60000); 
    
    // ğŸ’µ ëˆ ì—…ë°ì´íŠ¸ ë° ì €ì¥ í•¨ìˆ˜
    function updateMoney(amount) {
        currentMoney += amount;
        currentMoney = Math.max(0, currentMoney); // ìŒìˆ˜ ë°©ì§€
        moneyDisplay.textContent = currentMoney;
        localStorage.setItem('focusFlightMoney', currentMoney);
    }

    // ----------------------------------------------------
    // ğŸ› ï¸ í—¬í¼ í•¨ìˆ˜ (íƒ€ì´ë¨¸, íŒì—…, ê²½ë¡œ ê³„ì‚° ë“±) (ì—…ë°ì´íŠ¸)
    // ----------------------------------------------------
    
    function formatTime(sec){
        const h=Math.floor(sec/3600);
        const m=Math.floor((sec%3600)/60);
        const s=sec%60;
        // ìš”ì²­ëœ í¬ë§·: 00H 00M 00S
        return `${String(h).padStart(2,'0')}H ${String(m).padStart(2,'0')}M ${String(s).padStart(2,'0')}S`;
    }

    let popupTimer = null;
    function showPopup(message, duration) {
        if (popupTimer) {
            clearTimeout(popupTimer); 
        }
        flightPopup.innerHTML = message;
        flightPopup.style.display = 'block'; 
        
        popupTimer = setTimeout(() => {
            flightPopup.style.display = 'none';
        }, duration);
    }

    // ğŸŒŸ ë¹„í–‰ ì™„ë£Œ ìŠ¤íƒ¬í”„ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ ì¶”ê°€ (ê¸°ì¡´ ìœ ì§€)
    function showStampAnimation() {
        stampAnimation.classList.add('stamp-animate');
        // 4ì´ˆ í›„ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±° ë° ìˆ¨ê¹€
        setTimeout(() => {
            stampAnimation.classList.remove('stamp-animate');
        }, 4000); 
    }

    function startTimer(duration, focusMode){ 
        clearInterval(timerInterval);
        timerSeconds=duration;
        timerDisplay.textContent=formatTime(timerSeconds);
        focusStatus.textContent = `[ğŸ§˜ ${focusMode}] ëª¨ë“œ í™œì„±í™”`; 
        timerInterval=setInterval(()=>{
            if(timerSeconds<=0){ 
                saveFlightRecord(); 
                showStampAnimation(); 
                stopFlight(true); 
                return; 
            } 
            timerSeconds--; 
            timerDisplay.textContent=formatTime(timerSeconds);
        },1000);
    }
    
    function greatCircle(from,to,steps){ 
        const lat1=from[0]*Math.PI/180, lon1=from[1]*Math.PI/180;
        const lat2=to[0]*Math.PI/180, lon2=to[1]*Math.PI/180;
        const d=2*Math.asin(Math.sqrt(Math.sin((lat2-lat1)/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin((lon2-lon1)/2)**2));
        const path=[];
        for(let i=0;i<=steps;i++){
            const f=i/steps;
            const A=Math.sin((1-f)*d)/Math.sin(d);
            const B=Math.sin(f*d)/Math.sin(d);
            const x=A*Math.cos(lat1)*Math.cos(lon1)+B*Math.cos(lat2)*Math.cos(lon2);
            const y=A*Math.cos(lat1)*Math.sin(lon1)+B*Math.cos(lat2)*Math.sin(lon2);
            const z=A*Math.sin(lat1)+B*Math.sin(lat2);
            const lat=Math.atan2(z,Math.sqrt(x*x+y*y));
            const lon=Math.atan2(y,x);
            path.push([lat*180/Math.PI,lon*180/Math.PI]);
        }
        return path;
    }
    
    function moveMarkerWithTimer(from,to,durationSec,callback){ 
        if(flightLine) map.removeLayer(flightLine);
        if(flightMarker) map.removeLayer(flightMarker);
        
        if (departureAirportMarker) { departureAirportMarker.addTo(map); }
        if (arrivalAirportMarker) { arrivalAirportMarker.addTo(map); }
        
        map.setView(from,13); 
        
        const destLat = to[0];
        const destLon = to[1];

        const fps=30;
        const steps=durationSec*fps;
        const path=greatCircle(from,to,steps);
        flightLine=L.polyline(path,{color:'#0077ff'}).addTo(map);
        flightMarker=L.marker(from, {icon: airplaneIcon}).addTo(map); 
        let step=0;
        
        // ğŸ†• ê±°ë¦¬-ëˆ íšë“ ë¡œì§ ê´€ë ¨ ë³€ìˆ˜
        let lastCalculatedDistance = initialFlightDistance; 
        lastMoneyGainDistance = 0; // ì´ë¥™ ì‹œì ì—ì„œëŠ” 0kmë¡œ ì´ˆê¸°í™”

        function animate(){
            if(step>=path.length){ 
                distanceDisplay.textContent = '0 km'; 
                showPopup("ë¹„í–‰ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤ ì¢‹ì€ ì—¬í–‰ ë˜ì„¸ìš”ğŸ›¬", 3000);
                if(callback) callback(); 
                return; 
            }
            
            const currentLat = path[step][0];
            const currentLon = path[step][1];
            
            flightMarker.setLatLng(path[step]);
            
            // ğŸ—ºï¸ autoFollow ìƒíƒœì— ë”°ë¼ ë§µ ì´ë™ ê²°ì •
            if(autoFollow) {
                map.panTo(path[step],{animate:false});
                map.setZoom(13); 
            }

            const remainingDistance = calculateDistance(currentLat, currentLon, destLat, destLon);
            distanceDisplay.textContent = `${remainingDistance.toFixed(0)} km`; 
            
            // ğŸ’° ëˆ íšë“ ë¡œì§
            const distanceTraveledSinceStart = lastCalculatedDistance - remainingDistance;
            const newTotalTraveled = Math.max(0, distanceTraveledSinceStart);
            
            const gainableDistance = newTotalTraveled - lastMoneyGainDistance;
            
            if (gainableDistance >= 20) {
                const moneyGained = Math.floor(gainableDistance / 20) * 5;
                updateMoney(moneyGained);
                lastMoneyGainDistance += Math.floor(gainableDistance / 20) * 20; 
            }

            step++; 
            setTimeout(animate,1000/fps);
        }
        animate();
    }
    
    function generateFlightNumber(){ 
        const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums='0123456789';
        return letters.charAt(Math.floor(Math.random()*26))+letters.charAt(Math.floor(Math.random()*26))
            +nums.charAt(Math.floor(Math.random()*10))+nums.charAt(Math.floor(Math.random()*10))
            +nums.charAt(Math.floor(Math.random()*10));
    }
    
    /**
     * ğŸŒŸ ì¢Œì„ ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ í•¨ìˆ˜ (í™•ë¥  ì—…ë°ì´íŠ¸)
     */
    function isSeatAvailable(seatClass) {
        const rand = Math.random();
        if (seatClass === 'F') return rand < 0.04; // 4% ì˜ˆì•½ ê°€ëŠ¥
        if (seatClass === 'B') return rand < 0.10; // 10% ì˜ˆì•½ ê°€ëŠ¥
        return rand < 0.89; // 89% ì˜ˆì•½ ê°€ëŠ¥ (ë‚˜ë¨¸ì§€ 1%ëŠ” ì—ëŸ¬/ë¯¸í™•ì¸ ì¢Œì„ìœ¼ë¡œ ê°€ì •)
    }

    
    // ----------------------------------------------------
    // ğŸŒ UI ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì„ íƒ, ëª¨ë‹¬, ë Œë”ë§)
    // ----------------------------------------------------
    
    function renderDepartureSelect(filter = '') {
        const filterText = filter.toLowerCase();
        const currentSelected = departureSelect.value; 
        departureSelect.innerHTML = ''; 
        
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "ì¶œë°œ ë„ì‹œ ì„ íƒ";
        placeholder.disabled = true;
        departureSelect.appendChild(placeholder);
        
        Object.keys(airportData).forEach(city => {
            const airport = airportData[city];
            const searchText = `${city} ${airport.code} ${airport.name}`.toLowerCase();
            
            if (filterText === '' || searchText.includes(filterText)) {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = `${airport.code} - ${city}`; 
                departureSelect.appendChild(opt);
            }
        });
        
        if (currentSelected && departureSelect.querySelector(`option[value="${currentSelected}"]`)) {
            departureSelect.value = currentSelected;
        } else {
            departureSelect.value = "";
        }
    }

    renderDepartureSelect();

    departureSearch.oninput = () => {
        renderDepartureSelect(departureSearch.value);
    };

    departureSelect.onchange=()=>{ 
      currentDeparture=departureSelect.value;
      selectedFlightInfo.style.display='none'; 
      selectedArrival=null; 
      
      arrivalSearch.style.display = 'block';
      arrivalSearch.value = '';
      greetingContainer.style.display = 'none';
      renderArrivalList(); 
    };

    /**
     * ğŸŒŸ í‹°ì¼“íŒ… ëª¨ë‹¬ ì—´ê¸° ë° ìƒíƒœ ì´ˆê¸°í™” (ê¸°ì¡´ ìœ ì§€ + ê¸ˆì•¡ í™•ì¸ ë¡œì§ ë¶„ë¦¬)
     */
    function showTicketModal() {
        if (!currentDeparture || !selectedArrival) return; 
        
        seatAvailabilityMap = {};
        selectedSeat = null; 
        selectedFocusMode = null; 

        boardingPassContainer.style.display = 'none'; 
        boardingPassContainer.classList.remove('show');
        
        seatSelectionContainer.style.display = 'block'; 
        seatSelectionContainer.classList.remove('collapsed'); 
        
        document.getElementById('focusModeSelector').style.display = 'block'; 
        
        reselectSeatBtn.classList.add('hidden'); 
        selectionButtons.style.display = 'flex'; 

        renderSeats();
        renderFocusModeButtons();
        updateSelectionDisplay(); 
        
        confirmSelectionBtn.disabled = true;

        arrivalList.style.display = 'none'; 
        arrivalSearch.style.display = 'none'; 
        ticketBtn.style.display='none'; 
        
        modal.style.display='flex'; 
    }
    
    /**
     * ğŸŒŸ ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ í™œì„±í™” ì²´í¬ (ê¸°ì¡´ ìœ ì§€)
     */
    function updateSelectionDisplay() {
        selectedSeatDisplay.textContent = selectedSeat || 'ì¢Œì„ ì—†ìŒ';
        selectedFocusModeDisplay.textContent = selectedFocusMode || 'ëª¨ë“œ ì—†ìŒ';
        
        // ì¢Œì„ê³¼ ì§‘ì¤‘ ëª¨ë“œê°€ ëª¨ë‘ ì„ íƒë˜ì—ˆì„ ë•Œë§Œ ë°œê¶Œ ë²„íŠ¼ í™œì„±í™”
        if (selectedSeat && selectedFocusMode) {
            confirmSelectionBtn.disabled = false;
        } else {
            confirmSelectionBtn.disabled = true;
        }
    }

    /**
     * ğŸŒŸ ì¢Œì„ ì„ íƒ ì‹œ ì¢Œì„ ì§€ë„ë§Œ ì ‘ê¸° (ê¸°ì¡´ ìœ ì§€)
     */
    function autoCollapseSeatSelection() {
        if (selectedSeat) {
            seatSelectionContainer.classList.add('collapsed');
            reselectSeatBtn.classList.remove('hidden');
        }
    }

    /**
     * ğŸŒŸ ì¢Œì„ ë‹¤ì‹œ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í™•ì¥ ì²˜ë¦¬ (ê¸°ì¡´ ìœ ì§€)
     */
    reselectSeatBtn.onclick = () => {
        seatSelectionContainer.classList.remove('collapsed');
        reselectSeatBtn.classList.add('hidden');
    };

    /**
     * ğŸŒŸ ë³´ë”© íŒ¨ìŠ¤ ë Œë”ë§ ë° ì• ë‹ˆë©”ì´ì…˜ ì ìš© (ê¸°ì¡´ ìœ ì§€)
     */
    function renderBoardingPass() {
        const depAirport = airportData[currentDeparture];
        const arrAirport = airportData[selectedArrival];
        const flightNum = generateFlightNumber();
        const gateNum = String.fromCharCode(65 + Math.floor(Math.random() * 5)) + Math.floor(Math.random() * 10);
        
        const seatRow = parseInt(selectedSeat.slice(0, -1));
        let flightClass = 'ECONOMY'; 
        if (seatRow === 1) {
            flightClass = 'FIRST'; 
        } else if (seatRow >= 2 && seatRow <= 3) {
            flightClass = 'BUSINESS'; 
        }
        
        const depLat = depAirport.lat;
        const depLon = depAirport.lon;
        const arrLat = arrAirport.lat;
        const arrLon = arrAirport.lon;
        const totalDistance = calculateDistance(depLat, depLon, arrLat, arrLon);
        initialFlightDistance = totalDistance;

        bpRoute.textContent = `${depAirport.code} â†’ ${arrAirport.code}`;
        bpFlightNo.textContent = `FLT: ${flightNum}`;
        bpGate.textContent = `GATE: ${gateNum}`;
        bpClass.textContent = `CLASS: ${flightClass}`;
        bpSeat.textContent = selectedSeat;
        bpFocusMode.textContent = selectedFocusMode; 
        bpBarcodeText.textContent = `${flightNum}-${gateNum}-${selectedSeat}-${selectedFocusMode}-${userName || 'DUKKI'}`; 
        
        pendingFlight = {
            from: currentDeparture,
            to: selectedArrival,
            seat: selectedSeat,
            focus: selectedFocusMode,
            flightNumber: flightNum,
            time: new Date().toLocaleString(),
            distance: totalDistance, 
            duration: flightTimes[`${currentDeparture}-${selectedArrival}`] || (5*3600)
        };
        
        // ì¢Œì„/ëª¨ë“œ ì„ íƒ UI ìˆ¨ê¸°ê¸°
        seatSelectionContainer.style.display = 'none'; 
        document.getElementById('focusModeSelector').style.display = 'none'; 
        reselectSeatBtn.classList.add('hidden'); 
        selectionButtons.style.display = 'none'; 
        
        // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì¤€ë¹„ ë° í”„ë¦°íŠ¸ íš¨ê³¼ ì ìš©
        boardingPassContainer.classList.remove('show');
        boardingPassContainer.style.display = 'block';
        
        // í”„ë¦°íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                boardingPassContainer.classList.add('show');
            });
        });

        slideHandle.style.left = '2px';
        slideBackground.style.width = '0px';
        slideTrack.classList.remove('scanned'); 
        slideText.textContent = 'ë°€ì–´ì„œ í‹°ì¼“ ìŠ¤ìº” ğŸ«'; 
    }
    
    /**
     * ğŸš¨ ê¸ˆì•¡ í™•ì¸ í›„ í‹°ì¼“ ë°œê¶Œ (ë¡œì§ ì—…ë°ì´íŠ¸)
     */
    confirmSelectionBtn.onclick = () => {
        if (!selectedSeat) { alert('ì¢Œì„ ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        if (!selectedFocusMode) { alert('ì§‘ì¤‘ ëª¨ë“œ ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        
        const seatRow = parseInt(selectedSeat.slice(0, -1));
        let requiredMoney = 0;

        if (seatRow === 1) { 
            requiredMoney = 300; // í¼ìŠ¤íŠ¸ í´ë˜ìŠ¤
        } else if (seatRow >= 2 && seatRow <= 3) { 
            requiredMoney = 100; // ë¹„ì¦ˆë‹ˆìŠ¤ í´ë˜ìŠ¤
        }

        if (currentMoney < requiredMoney) {
            showPopup(`ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ğŸ˜¥ (í•„ìš” ê¸ˆì•¡: ${requiredMoney}ì›)`, 3000);
            return; 
        }

        // ê¸ˆì•¡ ì°¨ê° (í¼ìŠ¤íŠ¸/ë¹„ì¦ˆë‹ˆìŠ¤ í´ë˜ìŠ¤ë§Œ)
        if (requiredMoney > 0) {
            updateMoney(-requiredMoney); 
            showPopup(`ì”ì•¡ ${requiredMoney}ì› ì°¨ê°. ë°œê¶Œì„ ì‹œì‘í•©ë‹ˆë‹¤.`, 3000);
        }

        // ì˜ˆë§¤ ê°€ëŠ¥í•˜ë©´ ë°œê¶Œ ì§„í–‰
        renderBoardingPass(); 
    };
    
    /**
     * ğŸŒŸ ë„ì°©ì§€ ëª©ë¡ ë Œë”ë§ (ê¸°ì¡´ ìœ ì§€)
     */
    function renderArrivalList(filter = ''){
        arrivalList.innerHTML=''; 
        const filterText = filter.toLowerCase();

        if (currentDeparture) {
            arrivalList.style.display='block';
            ticketBtn.style.display='none'; 
        } else {
            arrivalList.style.display='none';
            ticketBtn.style.display='none';
        }
        
        distanceDisplay.textContent = '0 km'; 

        Object.keys(airportData).forEach(city=>{
            if(city===currentDeparture) return;
            
            const arrAirport = airportData[city];
            const searchText = `${city} ${arrAirport.code} ${arrAirport.name}`.toLowerCase();
            
            if (filterText && !searchText.includes(filterText)) {
                return;
            }

            const key=currentDeparture+'-'+city;
            const durationSec=flightTimes[key] || (5*3600); 
            const durationStr=formatTime(durationSec).replace(/ /g, '').toLowerCase(); 
            const div=document.createElement('div');
            div.className='arrival-item';
            
            div.innerHTML=`
                <div>${arrAirport.code} - ${city}</div>
                <div style="font-size: 13px; color: var(--color-text-dim); margin-top: 3px;">
                    ${arrAirport.name} - ${durationStr}
                </div>
            `;
            
            const isSelected = selectedArrival === city;
            if (selectedArrival !== null && !isSelected) {
                 div.style.display = 'none';
                 return;
            }
            
            if (isSelected) {
                div.classList.add('selected-arrival');
                ticketBtn.style.display='block';
                ticketBtn.textContent='ì¢Œì„ ì„ íƒ';
                ticketBtn.onclick=showTicketModal; 
                ticketBtn.onmousedown = null;
            }

            div.onclick=()=>{
                arrivalSearch.style.display = 'none';

                document.querySelectorAll('.arrival-item').forEach(item => {
                    item.style.display = 'none';
                    item.classList.remove('selected-arrival');
                });
                
                div.classList.add('selected-arrival');
                div.style.display = 'block'; 
                
                selectedArrival=city;

                ticketBtn.style.display='block';
                ticketBtn.textContent='ì¢Œì„ ì„ íƒ';
                
                ticketBtn.onclick=showTicketModal; 
                ticketBtn.onmousedown = null;
            };
            arrivalList.appendChild(div);
        });
    }

    arrivalSearch.oninput = () => {
        renderArrivalList(arrivalSearch.value);
    };

    /**
     * ğŸŒŸ ì¢Œì„ ë Œë”ë§ (í™•ë¥  ë° UI ìœ ì§€)
     */
    function renderSeats(){ 
        const seatMapContainer = document.getElementById('seatMap');
        seatMapContainer.innerHTML = '';
        const totalRows = 10; 
        const cols = ['A','B','C', '','D','E','F']; 

        for(let r=1; r<=totalRows; r++){
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            
            let seatClass = 'E'; 
            if (r === 1) {
                seatClass = 'F'; 
            } else if (r >= 2 && r <= 3) {
                seatClass = 'B'; 
            }

            cols.forEach((col, idx)=>{
                if(col === ''){
                    const aisle = document.createElement('div');
                    aisle.className = 'aisle';
                    rowDiv.appendChild(aisle);
                } else {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    const seatId = `${r}${col}`;
                    seat.dataset.seat = seatId;
                    seat.dataset.class = seatClass; 
                    
                    seat.textContent = seatId; 

                    let isAvailable;
                    if (seatAvailabilityMap.hasOwnProperty(seatId)) {
                        isAvailable = seatAvailabilityMap[seatId];
                    } else {
                        isAvailable = isSeatAvailable(seatClass);
                        seatAvailabilityMap[seatId] = isAvailable; 
                    }
                    
                    if (!isAvailable) {
                        seat.classList.add('unavailable');
                    }

                    if (selectedSeat === seatId) {
                        seat.classList.add('selected');
                    }
                    
                    seat.onclick = ()=>{
                        if (!isAvailable) {
                            showPopup("ì´ë¯¸ ì˜ˆì•½ëœ ì¢Œì„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", 2000);
                            return;
                        }
                        
                        document.querySelectorAll('#seatMap .seat').forEach(s=>s.classList.remove('selected'));
                        seat.classList.add('selected');
                        
                        selectedSeat = seat.dataset.seat;
                        updateSelectionDisplay(); 
                        autoCollapseSeatSelection(); 
                    };
                    rowDiv.appendChild(seat);
                }
            });
            seatMapContainer.appendChild(rowDiv);
        }
    }

    /**
     * ğŸŒŸ ì§‘ì¤‘ ëª¨ë“œ ë Œë”ë§ (ê¸°ì¡´ ìœ ì§€)
     */
    function renderFocusModeButtons(){ 
        focusModeButtonsContainer.innerHTML = '';

        const focusModes = [
            { mode: 'STUDY', emoji: 'ğŸ“š', color: '#0077ff' }, 
            { mode: 'BOOK', emoji: 'ğŸ“–', color: '#28a745' },  
            { mode: 'MUSIC', emoji: 'ğŸ§', color: '#ffc107' }, 
            { mode: 'REST', emoji: 'ğŸ’¤', color: '#dc3545' }   
        ];
        
        focusModes.forEach(item => {
            const button = document.createElement('button');
            button.className = 'focus-button';
            button.innerHTML = `${item.emoji} ${item.mode}`;
            button.dataset.mode = item.mode;
            
            button.style.backgroundColor = item.color;

            if (selectedFocusMode === item.mode) {
                 button.classList.add('selected');
            }

            button.onclick = () => {
                document.querySelectorAll('.focus-button').forEach(b => b.classList.remove('selected'));
                button.classList.add('selected');
                selectedFocusMode = item.mode;
                updateSelectionDisplay(); 
            };

            focusModeButtonsContainer.appendChild(button);
        });
    }

    // 5ì´ˆ ê¾¹ ëˆ„ë¦„ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    function handleStopFlightStart(event) {
        event.preventDefault(); 
        if (pressTimer) return;
        const startTime = Date.now();
        
        ticketBtn.style.setProperty('--progress', '0%');
        ticketBtn.style.transition = 'background-image 0.05s linear'; 
        
        pressTimer = setInterval(() => {
            const elapsedTime = Date.now() - startTime;
            const progress = Math.min(1, elapsedTime / PRESS_DURATION);
            const progressPercent = progress * 100;

            ticketBtn.style.setProperty('--progress', `${progressPercent}%`);
            ticketBtn.style.backgroundImage = `linear-gradient(to right, var(--color-accent-red) ${progressPercent}%, var(--color-primary) ${progressPercent}%)`;

            if (progress >= 1) {
                handleStopFlightEnd(); 
                realStopFlight(); 
            }
        }, 50); 
    }

    function handleStopFlightEnd() { 
        if (pressTimer) {
            clearInterval(pressTimer);
            pressTimer = null;
        }
        ticketBtn.style.setProperty('--progress', '0%');
        ticketBtn.style.backgroundImage = 'linear-gradient(to right, var(--color-accent-red) 0%, var(--color-primary) 0%)';
        ticketBtn.style.transition = 'none'; 
    }

    function realStopFlight() { 
        alert("ë¹„í–‰ì´ ê°•ì œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì§‘ì¤‘ ëª¨ë“œë¥¼ ì´íƒˆí–ˆìŠµë‹ˆë‹¤. ğŸ›‘");
        saveFlightRecord(); 
        stopFlight(false); 
    }
    
    document.getElementById('closeModalBtn').onclick=()=>{ 
        modal.style.display='none';
        document.getElementById('focusModeSelector').style.display = 'block'; 
        arrivalSearch.style.display = 'block';
        renderArrivalList(arrivalSearch.value); 
        if (userName) updateGreeting(userName);
    };
    
    
    // ----------------------------------------------------
    // ğŸš€ ìŠ¬ë¼ì´ë” ë“œë˜ê·¸ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    let isDragging = false;
    let startOffset = 0; 
    const SLIDE_THRESHOLD = 0.9; 
    const HANDLE_WIDTH = 40;
    const TRACK_PADDING = 2; 

    function getX(event) {
        if (event.touches) {
            return event.touches[0].clientX;
        }
        return event.clientX;
    }

    slideTrack.addEventListener('mousedown', startDrag);
    slideTrack.addEventListener('touchstart', startDrag);

    function startDrag(event) {
        if (slideTrack.classList.contains('scanned')) return; 

        isDragging = true;
        slideTrack.classList.add('sliding');
        
        const clientX = getX(event);
        const trackRect = slideTrack.getBoundingClientRect();
        const handleRect = slideHandle.getBoundingClientRect();

        if (clientX >= handleRect.left && clientX <= handleRect.right) {
            startOffset = clientX - handleRect.left;
        } else {
            startOffset = HANDLE_WIDTH / 2;
        }
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', endDrag);

        slideTrack.style.cursor = 'grabbing';
        event.preventDefault(); 
    }

    function drag(event) {
        if (!isDragging) return;

        const clientX = getX(event);
        const trackRect = slideTrack.getBoundingClientRect();
        
        const maxLeft = trackRect.width - HANDLE_WIDTH - TRACK_PADDING;
        let newLeft = clientX - trackRect.left - startOffset;

        newLeft = Math.max(TRACK_PADDING, newLeft);
        newLeft = Math.min(maxLeft, newLeft);
        
        slideHandle.style.left = `${newLeft}px`;
        
        const backgroundWidth = newLeft + (HANDLE_WIDTH / 2) - TRACK_PADDING;
        slideBackground.style.width = `${backgroundWidth}px`;

        event.preventDefault(); 
    }

    function endDrag(event) {
        if (!isDragging) return;
        isDragging = false;
        slideTrack.classList.remove('sliding');

        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('touchend', endDrag);

        slideTrack.style.cursor = 'grab';

        const trackRect = slideTrack.getBoundingClientRect();
        const handleLeft = slideHandle.offsetLeft;
        
        const slideDistance = handleLeft - TRACK_PADDING;
        const maxSlideDistance = trackRect.width - HANDLE_WIDTH - (2 * TRACK_PADDING);
        const slideRatio = slideDistance / maxSlideDistance;
        
        if (slideRatio >= SLIDE_THRESHOLD) {
            slideTrack.classList.add('scanned');
            slideHandle.style.left = `${trackRect.width - HANDLE_WIDTH - TRACK_PADDING}px`; 
            slideBackground.style.width = `${trackRect.width}px`; 
            slideHandle.style.backgroundColor = '#28a745'; 
            
            slideText.textContent = 'í‹°ì¼“ ìŠ¤ìº” ì™„ë£Œ âœ…';

            // ğŸš€ ë¹„í–‰ ì‹œì‘ ë¡œì§ í˜¸ì¶œ
            startFlight(); 
        } else {
            // ì›ìœ„ì¹˜ ë³µê·€
            slideHandle.style.transition = 'left 0.3s ease-in-out';
            slideBackground.style.transition = 'width 0.3s ease-in-out';
            slideHandle.style.left = '2px';
            slideBackground.style.width = '0px';

            setTimeout(() => {
                slideHandle.style.transition = 'none';
                slideBackground.style.transition = 'none';
            }, 300); 
        }
    }
    // ------------------------------------
    
    // ----------------------------------------------------
    // âœˆï¸ ë¹„í–‰ ì‹œì‘/ì¤‘ì§€/ì €ì¥ í•µì‹¬ ë¡œì§ (ì—…ë°ì´íŠ¸)
    // ----------------------------------------------------
    
    /**
     * ğŸš€ ë¹„í–‰ ì‹œì‘
     */
    function startFlight() {
        if(!pendingFlight){ 
            alert('ë¹„í–‰ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.'); 
            modal.style.display='none';
            renderArrivalList();
            return; 
        }

        showPopup("í‹°ì¼“ì´ ìŠ¤ìº”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹„í–‰ì„ ì‹œì‘í•©ë‹ˆë‹¤! ğŸ›«", 3000);

        const focus = pendingFlight.focus;
        const depAirport = airportData[pendingFlight.from];
        const arrAirport = airportData[pendingFlight.to];
        const duration = pendingFlight.duration;
        const totalDistance = pendingFlight.distance;
        
        selectedArrival = pendingFlight.to; // í˜„ì§€ ì‹œê°„ ê³„ì‚°ì„ ìœ„í•´ ì„¤ì •
        updateClocks(); 

        modal.style.display='none';
        
        // ğŸ”„ íƒ€ì´ë¨¸ UIë¥¼ ë¹„í–‰ ì¤‘ ëª¨ë“œë¡œ ì „í™˜
        timerContainer.classList.add('is-flight-active');
        timerMainDisplay.style.display = 'flex';
        focusStatus.style.display = 'block';
        clockContainer.style.display = 'flex';
        timerDisplayPreFlight.style.display = 'none'; 

        // ğŸ†• ğŸ“/â˜ï¸ ë²„íŠ¼ í‘œì‹œ
        toggleFollowBtn.style.display = 'flex'; 
        
        // ğŸ’° ëˆ ë²„íŠ¼ ë¹„í–‰ ì¤‘ ìœ„ì¹˜ë¡œ ì´ë™
        moneyButton.classList.add('in-flight');

        // ì¶œë°œ/ë„ì°© ê³µí•­ ë§ˆì»¤ í‘œì‹œ
        const depLatLng = [depAirport.lat, depAirport.lon];
        const arrLatLng = [arrAirport.lat, arrAirport.lon];

        if (departureAirportMarker) map.removeLayer(departureAirportMarker);
        if (arrivalAirportMarker) map.removeLayer(arrivalAirportMarker);

        departureAirportMarker = L.marker(depLatLng, {
            icon: createAirportIcon(depAirport.code, true)
        }).addTo(map);
        
        arrivalAirportMarker = L.marker(arrLatLng, {
            icon: createAirportIcon(arrAirport.code, false)
        }).addTo(map);

        // ğŸ—ºï¸ ë¹„í–‰ ì‹œì‘ ì‹œ, ë”°ë¼ê°€ê¸° ëª¨ë“œ (autoFollow=true)ë¡œ ì„¤ì •
        autoFollow = true;
        followIcon.textContent = 'ğŸ“';
        map.setZoom(13);

        // ë¹„í–‰ ì¤‘ UI ì„¤ì •
        ticketBtn.textContent='ë¹„í–‰ ì¤‘ì§€ (5ì´ˆ ê¾¹)'; 
        
        focusStatus.textContent = `[ğŸ§˜ ${focus}] ëª¨ë“œ í™œì„±í™”`; 
        
        ticketBtn.classList.add('disabled-during-flight'); 

        departureSelect.style.display = 'none'; 
        arrivalList.style.display = 'none'; 
        arrivalSearch.style.display = 'none'; 
        departureSearch.style.display = 'none'; 
        controlsContainer.classList.add('controls-disabled'); 
        greetingContainer.style.display = 'none'; 

        // ë¹„í–‰ ì •ë³´ í‘œì‹œ
        selectedFlightInfo.innerHTML = `
            <div style="font-size: 20px; font-weight: 900; color: var(--color-primary); margin-bottom: 8px;">
                ${depAirport.code} â†’ ${arrAirport.code}
            </div>
            <div class="flight-subtitle" style="margin-bottom: 4px;">
                ì¢Œì„ | ${pendingFlight.seat}
            </div>
            <div style="font-size: 14px; color: var(--color-text-light); margin-top: 4px;">
                ì¶œë°œ | ${depAirport.name}
            </div>
            <div style="font-size: 14px; color: var(--color-text-light);">
                ë„ì°© | ${arrAirport.name}
            </div>
        `;
        selectedFlightInfo.style.display = 'flex'; 
        ticketBtn.style.display='block'; 
        
        // ë¹„í–‰ ì¤‘ì§€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        ticketBtn.onclick = null; 
        ticketBtn.onmousedown = handleStopFlightStart;
        ticketBtn.onmouseup = handleStopFlightEnd;
        ticketBtn.onmouseleave = handleStopFlightEnd; 
        ticketBtn.ontouchstart = handleStopFlightStart;
        ticketBtn.ontouchend = handleStopFlightEnd;
        ticketBtn.ontouchcancel = handleStopFlightEnd;

        distanceDisplay.textContent = `${totalDistance.toFixed(0)} km`; 
        initialFlightDistance = totalDistance; 

        startTimer(duration, focus); 
        
        moveMarkerWithTimer(depLatLng,
                            arrLatLng,
                            duration,
                            ()=>{ 
                                departureSearch.style.display = 'block';
                                renderDepartureSelect(); 
                                departureSelect.value = pendingFlight.to; 
                                currentDeparture = pendingFlight.to;
                                renderArrivalList();
                                
                                const toAirport = airportData[pendingFlight.to];
                                map.setView([toAirport.lat, toAirport.lon], 13);
                            });
    }

    /**
     * ğŸ›‘ ë¹„í–‰ ì¤‘ì§€ 
     * @param {boolean} isCompleted - íƒ€ì´ë¨¸ ë§Œë£Œë¡œ ì •ìƒ ì™„ë£Œë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
     */
    function stopFlight(isCompleted) { 
        
        handleStopFlightEnd(); 
        clearInterval(timerInterval);
        
        // ğŸ”„ íƒ€ì´ë¨¸ UIë¥¼ ë¹„í–‰ ì „ ëª¨ë“œë¡œ ì „í™˜
        initializeTimerUI(); 
        
        // ğŸ†• ğŸ“/â˜ï¸ ë²„íŠ¼ ìˆ¨ê¹€
        toggleFollowBtn.style.display = 'none'; 
        
        // ğŸ’° ëˆ ë²„íŠ¼ ê¸°ë³¸ ìœ„ì¹˜ë¡œ ë³µê·€
        moneyButton.classList.remove('in-flight');

        // ğŸ†• ì¢Œì„ ì˜ˆì•½ ê°€ëŠ¥ì„± ë§µ ì´ˆê¸°í™”
        seatAvailabilityMap = {};
        lastMoneyGainDistance = 0;

        // ë§µ ìš”ì†Œ ì œê±°
        if(flightMarker) map.removeLayer(flightMarker);
        if(flightLine) map.removeLayer(flightLine);
        if(departureAirportMarker) map.removeLayer(departureAirportMarker);
        if(arrivalAirportMarker) map.removeLayer(arrivalAirportMarker);

        flightMarker=null; flightLine=null;
        departureAirportMarker=null;
        arrivalAirportMarker=null;
        
        timerSeconds=0;
        initialFlightDistance = 0; 
        
        selectedArrival = null; 

        // ğŸ—ºï¸ ë¹„í–‰ ì¢…ë£Œ ì‹œ, ë”°ë¼ê°€ê¸° ëª¨ë“œ (autoFollow=true)ë¡œ ì¬ì„¤ì •í•˜ê³  ì¤Œ ë ˆë²¨ì„ 2ë¡œ ë³€ê²½
        autoFollow = true;
        followIcon.textContent = 'ğŸ“';
        map.setZoom(2);
        
        // ë¹„í–‰ ì¢…ë£Œ UI ì„¤ì •
        controlsContainer.classList.remove('controls-disabled'); 
        ticketBtn.classList.remove('disabled-during-flight');
        
        ticketBtn.onmousedown = null;
        ticketBtn.onmouseup = null;
        ticketBtn.onmouseleave = null;
        ticketBtn.ontouchstart = null;
        ticketBtn.ontouchend = null;
        ticketBtn.ontouchcancel = null;

        selectedFlightInfo.style.display='none'; 
        departureSelect.style.display = 'block';
        departureSearch.style.display = 'block'; 
        
        if (!isCompleted) {
             departureSelect.value=''; 
             currentDeparture=null;
             renderDepartureSelect(); 
        }
        
        if (userName) {
            updateGreeting(userName); 
        }

        arrivalList.style.display='none'; 
        arrivalSearch.style.display = 'none'; 
        ticketBtn.style.display='none'; 
        
        pendingFlight=null;
        ticketBtn.textContent='ì¢Œì„ ì„ íƒ';

        hideAllContainers();
        document.getElementById('map').style.display='block';
        bottomNavUpdateActive('homeBtn');
    }

    /**
     * ğŸ’¾ ë¹„í–‰ ê¸°ë¡ ì €ì¥ (ê¸°ì¡´ ìœ ì§€)
     */
    function saveFlightRecord(){ 
        if(!pendingFlight) return;
        
        const remainingTime = timerSeconds; 
        const totalDuration = pendingFlight.duration;
        const focusDuration = totalDuration - remainingTime; 
        const focusPercentage = (totalDuration > 0) ? ((focusDuration / totalDuration) * 100).toFixed(1) : 0;

        pendingFlight.completionTime = new Date().toLocaleString();
        pendingFlight.focusDuration = focusDuration; 
        pendingFlight.focusPercentage = focusPercentage; 

        let records=JSON.parse(localStorage.getItem('focusFlightRecords')||'[]');
        records.push(pendingFlight);
        localStorage.setItem('focusFlightRecords',JSON.stringify(records));
        renderRecords(currentRecordFilter); 
        renderTrends(); 
    }
    
    // ----------------------------------------------------
    // ğŸ“œ ê¸°ë¡ ë° ì¶”ì„¸ ë Œë”ë§ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------

    function renderRecords(filter = 'all'){ 
        currentRecordFilter = filter; 
        const container=document.getElementById('records');
        container.innerHTML='';
        let records=JSON.parse(localStorage.getItem('focusFlightRecords')||'[]');
        
        let filteredRecords = records;
        if (filter === 'completed') {
            filteredRecords = records.filter(r => (r.focusDuration >= r.duration));
        } else if (filter === 'incomplete') {
            filteredRecords = records.filter(r => (r.focusDuration < r.duration));
        }
        
        document.querySelectorAll('.record-filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filter) {
                btn.classList.add('active');
            }
        });

        if (records.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:var(--color-text-dim); margin-top:30px;">ì•„ì§ ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë¹„í–‰ì„ ì‹œì‘í•˜ì„¸ìš”! ğŸ›«</p>`;
            return;
        }
        
        if (filteredRecords.length === 0) {
            let msg = 'ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
            if (filter === 'completed') msg = 'ì™„ë£Œëœ ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜”';
            else if (filter === 'incomplete') msg = 'ì¤‘ë‹¨ëœ ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ¥³';
            
            container.innerHTML = `<p style="text-align:center; color:var(--color-text-dim); margin-top:30px;">${msg}</p>`;
            return;
        }

        filteredRecords.slice().reverse().forEach(r=>{ 
            const depCode = airportData[r.from]?.code || 'N/A';
            const arrCode = airportData[r.to]?.code || 'N/A';
            
            const focusedTimeSec = r.focusDuration || 0;
            const focusedTimeStr = formatTime(focusedTimeSec); 
            const ratio = r.duration > 0 ? (focusedTimeSec / r.duration) : 0;
            const actualDistance = (r.distance || 0) * ratio;
            const distanceKm = actualDistance?.toFixed(0) || '0';
            
            const isCompleted = r.focusDuration >= r.duration;

            const completionStatus = isCompleted 
                ? `<span style="color:#28a745; font-weight:bold;">ì™„ë£Œ</span>` 
                : `<span style="color:var(--color-accent-red); font-weight:bold;">ì¤‘ë‹¨ (${(r.focusPercentage || '0.0')}% ì§‘ì¤‘)</span>`;

            const div=document.createElement('div');
            div.className='ticket-item';
            div.innerHTML=`
                <div class="ticket-main">
                    <div>
                        <div class="ticket-header">${depCode} â†’ ${arrCode}</div>
                        <div class="ticket-time-code">ëª¨ë“œ: <span class="ticket-info-value">${r.focus}</span></div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:24px; font-weight:900; color:#ff5555;">${focusedTimeStr.split(' ')[0]}</div>
                        <div style="font-size:12px; color:var(--color-text-dim);">${focusedTimeStr.split(' ').slice(1).join(' ')}</div>
                    </div>
                </div>
                <div class="ticket-info-panel">
                    <div><span class="ticket-info-label">FLIGHT NO:</span> <span class="ticket-info-value">${r.flightNumber}</span></div>
                    <div><span class="ticket-info-label">SEAT:</span> <span class="ticket-info-value">${r.seat}</span></div>
                    <div><span class="ticket-info-label">STATUS:</span> ${completionStatus}</div>
                    <div><span class="ticket-info-label">DISTANCE:</span> ${distanceKm} km</div>
                    <div style="width: 100%;"><span class="ticket-info-label">DATE:</span> ${r.time}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function renderTrends(){ 
        const records = JSON.parse(localStorage.getItem('focusFlightRecords') || '[]');
        const trendsData = document.getElementById('trendsData');
        trendsData.innerHTML = '';
        
        if (records.length === 0) {
            trendsData.innerHTML = `<p style="text-align:center; color:var(--color-text-dim); grid-column: 1 / 3; margin-top:20px;">ë¹„í–‰ ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ë¶„ì„ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ğŸ˜”</p>`;
            return;
        }
        
        const totalFlights = records.length;
        
        const completedRecords = records.filter(r => r.focusDuration >= r.duration);
        const completionRate = (totalFlights > 0) ? ((completedRecords.length / totalFlights) * 100).toFixed(0) : 0;

        const totalDurationSeconds = records.reduce((sum, r) => sum + (r.focusDuration ? r.focusDuration : 0), 0);
        const totalDurationFormatted = formatTime(totalDurationSeconds);
        
        const visitedAirports = new Set();
        records.forEach(r => {
            if (r.from) visitedAirports.add(r.from);
            if (r.to) visitedAirports.add(r.to);
        });
        const totalAirports = visitedAirports.size;

        const totalDistance = records.reduce((sum, r) => {
            if (r.focusDuration > 0 && r.distance && r.duration > 0) {
                const ratio = r.duration > 0 ? (r.focusDuration / r.duration) : 0;
                const actualDistance = r.distance * ratio;
                return sum + actualDistance;
            }
            return sum;
        }, 0);
        const totalDistanceFormatted = `${totalDistance.toFixed(0)}`;

        const focusModeCounts = records.reduce((acc, r) => {
            if(r.focus) { 
                 acc[r.focus] = (acc[r.focus] || 0) + 1;
            }
            return acc;
        }, {});
        
        let mostUsedMode = 'N/A';
        let maxCount = 0;
        for (const mode in focusModeCounts) {
            if (focusModeCounts[mode] > maxCount) {
                maxCount = focusModeCounts[mode];
                mostUsedMode = mode;
            }
        }
        
        const trendItems = [
            { label: "ì´ ë¹„í–‰ íšŸìˆ˜", value: totalFlights, unit: "íšŒ", type: "count" },
            { label: "ë¹„í–‰ ì„±ê³µë¥ ", value: completionRate, unit: "%", type: "percent" }, 
            { label: "ì´ ì§‘ì¤‘ ì‹œê°„", value: totalDurationFormatted, unit: "", type: "time" },
            { label: "ì´ ì´ë™ ê±°ë¦¬", value: totalDistanceFormatted, unit: "km", type: "distance" },
            { label: "ìµœë‹¤ ì§‘ì¤‘ ëª¨ë“œ", value: mostUsedMode, unit: "", count: maxCount, type: "mode" },
            { label: "ë°©ë¬¸ ê³µí•­ ìˆ˜", value: totalAirports, unit: "ê³³", type: "count" },
        ];
        
        const modeItem = trendItems.splice(4, 1)[0]; 
        trendItems.push(modeItem);

        trendsData.style.gridTemplateColumns = '1fr 1fr'; 
        
        trendItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'trend-item';
            
            let htmlContent = '';
            
            if (item.type === "time") {
                const parts = item.value.split(' ');
                htmlContent = `<div class="trend-label">${item.label}</div>
                                 <div class="trend-value" style="font-size:20px;">${parts.slice(0, 3).join(' ')}</div>
                                 <div style="font-size:12px; color:var(--color-text-dim);">ì‹œê°„/ë¶„/ì´ˆ</div>`;
            } else if (item.type === "mode") {
                const emojiMap = {
                    'STUDY': 'ğŸ“š', 'BOOK': 'ğŸ“–', 'MUSIC': 'ğŸ§', 'REST': 'ğŸ’¤', 'N/A': 'â­'
                };
                const emoji = emojiMap[item.value] || 'â­';
                
                htmlContent = `<div class="trend-label">${item.label}</div>
                                 <div class="trend-value" style="font-size: 24px;">${emoji} ${item.value}</div>
                                 <div style="font-size:12px; color:var(--color-text-dim);">${item.count}íšŒ ì‚¬ìš©</div>`;
                div.style.gridColumn = '1 / 3'; 
            } else {
                htmlContent = `<div class="trend-label">${item.label}</div>
                                 <div class="trend-value">${item.value}</div>
                                 <div style="font-size:12px; color:var(--color-text-dim);">${item.unit}</div>`;
            }
            
            div.innerHTML = htmlContent;
            trendsData.appendChild(div);
        });
    }
    // -----------------------------

    renderRecords(currentRecordFilter); 
    renderTrends(); 

    
    // ----------------------------------------------------
    // ğŸ§­ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë° ì„¤ì • ì´ë²¤íŠ¸ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    
    function hideAllContainers() {
        document.getElementById('map').style.display='none';
        recordsContainer.style.display='none';
        trendsContainer.style.display='none';
        settingsModal.style.display='none'; 
        if (!pendingFlight && userName) {
            updateGreeting(userName);
        } else {
             greetingContainer.style.display='none';
        }
    }

    function bottomNavUpdateActive(activeId) {
        bottomNavButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.id === activeId) {
                btn.classList.add('active');
            }
        });
    }

    document.getElementById('homeBtn').onclick=()=>{ 
        if (pendingFlight) return; 
        hideAllContainers();
        document.getElementById('map').style.display='block'; 
        bottomNavUpdateActive('homeBtn');
    };
    document.getElementById('recordBtn').onclick=()=>{ 
        if (pendingFlight) return; 
        hideAllContainers();
        greetingContainer.style.display = 'none';
        renderRecords(currentRecordFilter);
        recordsContainer.style.display='block'; 
        bottomNavUpdateActive('recordBtn');
    };
    document.getElementById('trendsBtn').onclick=()=>{ 
        if (pendingFlight) return;
        hideAllContainers();
        greetingContainer.style.display = 'none';
        renderTrends();
        trendsContainer.style.display='block'; 
        bottomNavUpdateActive('trendsBtn');
    };
    document.getElementById('settingsBtn').onclick = () => { 
        if (pendingFlight) return;
        hideAllContainers();
        document.getElementById('map').style.display='block';
        settingsModal.style.display = 'flex';
        bottomNavUpdateActive('settingsBtn');
    };
    
    document.querySelectorAll('.close-container-btn').forEach(btn => {
        btn.onclick = () => {
            hideAllContainers(); 
            document.getElementById('map').style.display = 'block'; 
            bottomNavUpdateActive('homeBtn');
        };
    });
    
    recordFilterButtons.forEach(btn => {
        btn.onclick = (e) => {
            const filter = e.target.dataset.filter;
            renderRecords(filter);
        };
    });

    clearRecordsBtn.onclick = () => { 
        const confirmClear = confirm("ì •ë§ë¡œ ëª¨ë“  ì—¬í–‰ ê¸°ë¡ì„ ì´ˆê¸°í™”(ì‚­ì œ) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        if (confirmClear) {
            localStorage.removeItem('focusFlightRecords');
            renderRecords('all'); 
            renderTrends();
            alert("ì—¬í–‰ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    };

    closeSettingsModalBtn.onclick = () => {
        settingsModal.style.display = 'none';
        bottomNavUpdateActive('homeBtn');
    };

    document.querySelectorAll('.map-style-button').forEach(button => {
        button.onclick = (e) => {
            const style = e.target.dataset.style;
            switchMapStyle(style);
            // settingsModal.style.display = 'none'; // ì„¤ì •ì„ ë‹«ì§€ ì•Šë„ë¡ ì£¼ì„ ì²˜ë¦¬
            // bottomNavUpdateActive('homeBtn');
        };
    });
    
    // ----------------------------------------------------
    // ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ì¶”ê°€
    // ----------------------------------------------------

    /**
     * ğŸ“¤ LocalStorage ë°ì´í„° ë‚´ë³´ë‚´ê¸° (.json íŒŒì¼ë¡œ ì €ì¥)
     */
    window.exportData = function() {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            // focusFlightìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ë§Œ ë°±ì—… ëŒ€ìƒìœ¼ë¡œ ì œí•œ (ì˜µì…˜)
            if (key.startsWith('focusFlight')) {
                 data[key] = localStorage.getItem(key);
            }
        }

        const dataJson = JSON.stringify(data, null, 2);
        const blob = new Blob([dataJson], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        a.download = `focusFlight_backup_${dateStr}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤! ğŸ’¾');
    }

    /**
     * ğŸ“¥ LocalStorage ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (íŒŒì¼ ì„ íƒ ë° ë®ì–´ì“°ê¸°)
     */
    window.importData = function() {
        if (!confirm('ê²½ê³ : ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ì €ì¥ëœ ì´ë¦„, ëˆ, ì—¬í–‰ ê¸°ë¡ì´ íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€í•˜ê³  ë°±ì—…ëœ ë°ì´í„°ë§Œ ë®ì–´ì“°ê±°ë‚˜ ì¶”ê°€ (ì„ íƒì )
                    // í˜„ì¬ëŠ” ë°±ì—… íŒŒì¼ì˜ keyë§Œ ë®ì–´ì“°ëŠ” ë°©ì‹ì„ ì‚¬ìš©
                    for (const key in data) {
                        if (key.startsWith('focusFlight')) { 
                             localStorage.setItem(key, data[key]);
                        }
                    }
                    
                    alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•˜ê¸° ìœ„í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤. ğŸ”„');
                    window.location.reload(); 
                    
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    // ----------------------------------------------------
    // ğŸš€ ì•± ì´ˆê¸° ì‹¤í–‰
    // ----------------------------------------------------
    
    loadUserName();
    updateClocks(); 
    initializeMoneyUI(); 
    
}); 
</script>
</body>
</html>
